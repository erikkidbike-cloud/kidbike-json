<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Belegung Verkehrsschulen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    /* Toast volledig uitschakelen */
    #successMsg { display: none !important; }
    
    /* toon vaste + knop op touch devices */
    .touch .mobile-add { display: block; }
    
    /* --- Fix horizontale scroll in embed --- */
    html, body { overflow-x: hidden; width:100%; max-width:100%; }
    header, .intro, #calendar { max-width: 100%; }

    /* FullCalendar binnen viewport houden */
    .fc, .fc-scrollgrid { max-width: 100% !important; }
    .fc .fc-scroller { overflow-x: hidden !important; }
    .fc .fc-scrollgrid table,
    .fc .fc-timegrid-body table { width: 100% !important; table-layout: fixed; }
    .fc .fc-toolbar { flex-wrap: wrap; }

    @media (max-width: 480px) {
      .controls { align-items: stretch; }
      .controls select { min-width: 0; width: 100%; }
    }

    /* compacter: inputs/padding */
    .field input,.field textarea,.field select{padding:7px 10px;min-height:40px}
    .btn{min-height:40px}

    /* waarschuwingen direct onder titel */
    .alert{margin:6px 0 10px;padding:8px 10px;border-radius:8px;font-size:13px}
    .alert.warn{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .alert.note{background:#fef9c3;border:1px solid #fde68a;color:#92400e}

    /* extras chips met prijsbadge en ≥44px touch */
    .badge{min-height:44px;padding:8px 12px;display:inline-flex;align-items:center;gap:6px}
    .badge .price{opacity:.8;font-weight:600;font-size:11px}

    /* prijs "pill" + toggle details */
    .price{display:flex;align-items:center;gap:8px}
    .price .pill{padding:6px 10px;border-radius:999px;background:#0ea5e91a;border:1px solid #bae6fd}
    .price .toggle{cursor:pointer;font-size:12px;text-decoration:underline}

    /* sticky submit-balk */
    .sticky-bar{position:sticky;bottom:0;z-index:5;background:#fff;border-top:1px solid var(--border);
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:0 0 12px 12px}
    .sticky-bar .sum{font-size:13px}
    .sticky-bar .sum b{font-weight:800}

    /* modal: fullscreen sheet op mobiel + body lock */
    @media (max-width:720px){
      .modal{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0;padding:14px}
      .modal h3{font-size:16px}
    }

    /* "X"-sluitknop in header */
    .modal .close-x{position:absolute;top:10px;right:12px;border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer}

    /* submit loading: spinner links en label zichtbaar */
    .btn.loading{color:#fff}
    .btn.loading::before{
      content:"";display:inline-block;width:16px;height:16px;margin-right:8px;
      border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite
    }

    /* focus trap hint (niet zichtbaar) */
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

    /* 1) Remove "Extras: 0 €" */
    #extrasRunning{display:none!important;}

    /* 2) Always show price details in Step 1 (no "Details" button) */
    #priceToggle{display:none!important;}

    /* 3) Fix extras "bubbles" layout/size - make them even more compact */
    .extras .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; min-height:32px; border-radius:999px;
      border:1px solid var(--border); background:#f8fafc; font-size:12px
    }
    .extras .badge input{margin-right:6px}
    .extras .badge .price{font-weight:600;opacity:.7;font-size:11px}

    /* 4) Make Step 2 more compact + put "Art der Feier" and "Nutzung Fahrräder" side-by-side */
    .row.cols-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .row.cols-2{grid-template-columns:1fr} }

    /* 5) Reduce vertical spacing a bit (both steps) */
    .grid{gap:10px}                 /* was 12px */
    .row{gap:6px}                   /* was 8px */
    .field{margin-bottom:8px}       /* was 10px */
    .field label{margin-bottom:3px} /* was 4px */

    /* 7) Hide sticky controls initially */
    #stickyBar .checkline, #btnSubmit { display:none; }

    /* Hide bikes-related UI completely */
    #labelBikes,[for="fBikes"]{display:none!important;}

    /* Name row sizing: short select + two flexible inputs */
    .row.cols-3{display:grid;grid-template-columns:120px 1fr 1fr;gap:10px}

    /* Contact row: email gets more space, dial code is narrow, phone flexes */
    .row.cols-contact{
      display:grid;
      grid-template-columns: 2fr 120px 1.4fr;
      gap:10px;
    }
    @media (max-width:720px){
      .row.cols-contact{grid-template-columns:1fr}
    }

    :root{
      --bg:#f7f9fb; --card:#ffffff; --border:#d8dee6; --ink:#111827;
      --muted:#667085; --brand:#0ea5e9; --busy:#036ba7; --green:#16a34a; --warn:#b91c1c;
      --popover:#0b3552; --popover-bg:#fff; --popover-border:#cfe7f6;
      --warning:#f59e0b; --warning-bg:#fef3c7; --warning-border:#fcd34d;
      --disabled:#9ca3af; --disabled-bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border)}
    header .left{display:flex;align-items:center;gap:12px}
    header img{height:40px;width:auto}
    header h1{font-size:18px;margin:0}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .controls label{color:var(--muted);font-size:14px}
    .controls select{
      appearance:none;font-size:16px;color:var(--ink);
      background:#fff;border:1px solid var(--border);border-radius:10px;
      padding:10px 12px;min-width:220px;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .controls option.disabled{color:var(--disabled)}

    .intro{max-width:1200px;margin:12px auto 0;background:var(--card);border:1px solid var(--border);
      border-radius:10px;padding:10px 14px;color:#1f2937}
    .intro p{margin:4px 0}

    #calendar{max-width:1200px;margin:10px auto;background:var(--card);border:1px solid var(--border);
      border-radius:10px;padding:6px;opacity:0;transition:opacity 0.25s;}
    #calendar.loaded{opacity:1;}
    .fc-theme-standard .fc-scrollgrid,.fc-theme-standard td,.fc-theme-standard th{border-color:var(--border)}
    .fc .fc-button{background:var(--busy);border:1px solid #045983;color:#fff;min-height:40px;font-size:13px;padding:6px 10px}
    .fc .fc-toolbar-title{font-weight:700;font-size:15px}
    .fc-timegrid-slot{min-height:20px;}
    .fc-event.busy{background:var(--busy)!important;border:1px solid #045983!important;color:#fff;}

    /* Tentative holds: duidelijke arcering + dashed rand */
    .fc-event.tentative {
      background: repeating-linear-gradient(
        45deg,
        rgba(14,165,233,0.16) 0 10px,
        rgba(14,165,233,0.28) 10px 20px
      ) !important;
      border: 2px dashed #0ea5e9 !important;
      color: #0b3b57 !important;
      box-shadow: inset 0 0 0 1px rgba(14,165,233,.25);
    }
    .fc-event.tentative .fc-event-title {
      font-weight: 800;
      letter-spacing: .2px;
    }

    .loading{display:flex;align-items:center;justify-content:center;padding:32px;color:var(--muted);}
    .loading::after{content:'';width:18px;height:18px;margin-left:8px;border:2px solid var(--border);border-top:2px solid var(--brand);
      border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    .mobile-add{position:fixed;bottom:16px;right:16px;z-index:40;background:var(--brand);color:white;border:none;border-radius:50%;
      width:52px;height:52px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:22px;cursor:pointer;display:none;}
    .mobile-add:hover{filter:brightness(1.1)}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;overflow-y:auto;padding:16px;}
    .modal{width:100%;max-width:760px;background:var(--card);border-radius:12px;border:1px solid var(--border);padding:16px;position:relative;
      max-height:92vh;overflow-y:auto;margin:auto;box-shadow:0 20px 60px rgba(0,0,0,0.12);}
    .modal h3{margin:0 0 10px;font-size:18px;}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-1{grid-template-columns:1fr}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:end}
    .row > .field{margin-bottom:0}

    .field{margin-bottom:8px}
    .field label{display:block;margin-bottom:3px;font-weight:500;font-size:14px;color:var(--ink)}
    .field.required label::after{content:'*';color:var(--warn);margin-left:2px}
    .field input,.field textarea,.field select{
      width:100%;border:1px solid var(--border);border-radius:8px;font-size:16px;background:#fff;
      transition:border-color 0.2s,box-shadow 0.2s;
    }
    .field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(14,165,233,0.1)}
    .field input:invalid{border-color:var(--warn)}
    .field input[type="datetime-local"]{font-family:monospace}
    .field textarea{resize:vertical;min-height:80px}

    .field--checkbox{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .field--checkbox input[type="checkbox"]{width:auto;margin:0}
    .field--checkbox label{margin:0;font-weight:400;cursor:pointer}

    .btn{background:var(--brand);color:white;border:none;border-radius:8px;padding:10px 16px;font-size:14px;font-weight:600;
      cursor:pointer;transition:background 0.2s;text-align:center;text-decoration:none;display:inline-block;}
    .btn:hover{background:var(--busy)}
    .btn:disabled{background:var(--disabled);cursor:not-allowed}
    .btn.secondary{background:var(--card);color:var(--ink);border:1px solid var(--border)}
    .btn.secondary:hover{background:#f9fafb}

    /* price styling */
    .price{display:flex;align-items:center;gap:8px;margin:6px 0}
    .price .pill{background:#e0f2fe;border:1px solid #0ea5e9;color:#0c4a6e;padding:6px 10px;border-radius:999px;font-weight:600;font-size:14px}
    .price .toggle{color:var(--brand);font-size:12px;cursor:pointer;text-decoration:underline}

    .breakdown{background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:10px;margin:8px 0;font-size:13px;display:none}
    .breakdown .row{display:flex;justify-content:space-between;margin:2px 0;padding:2px 0}
    .breakdown .row.total{border-top:1px solid var(--border);margin-top:6px;padding-top:6px;font-weight:700}
    .breakdown .muted{color:var(--muted)}

    .extras{margin:8px 0}
    .extras .badge{display:inline-flex;align-items:center;gap:6px;margin:4px 6px 4px 0;padding:4px 10px;
      border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer;transition:background 0.2s;font-size:12px;min-height:32px}
    .extras .badge:hover{background:#f1f5f9}
    .extras .badge input{margin:0}
    .extras .badge .price{font-weight:600;opacity:.7;font-size:11px}

    .popover{position:absolute;background:var(--popover-bg);border:1px solid var(--popover-border);border-radius:8px;
      padding:8px 10px;font-size:12px;color:var(--popover);max-width:200px;z-index:30;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none}

    .tooltip-wrap{position:relative}
    .tooltip-icon{background:var(--brand);color:white;border-radius:50%;width:16px;height:16px;display:inline-flex;
      align-items:center;justify-content:center;font-size:10px;margin-left:4px;cursor:pointer}

    .steps{margin:10px 0;color:var(--muted);font-size:12px}

    .sticky-bar{position:sticky;bottom:0;z-index:10;background:var(--card);border-top:1px solid var(--border);
      padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;border-radius:0 0 12px 12px}
    .sticky-bar .sum{font-size:13px;color:var(--muted)}
    .sticky-bar .sum b{color:var(--ink);font-weight:800}
    .sticky-bar .checkline{display:flex;align-items:center;gap:6px;font-size:12px}

    .success-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60;padding:16px}
    .success-content{background:var(--card);border-radius:12px;padding:20px;max-width:500px;text-align:center;position:relative}
    .success-content h3{color:var(--green);margin:0 0 12px}
    .success-content .summary{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px;margin:12px 0;text-align:left;font-size:13px}

    /* responsive */
    @media (max-width:720px){
      .modal{max-width:100%;width:100%;height:100%;max-height:100%;border-radius:0;margin:0;padding:14px}
      .grid{grid-template-columns:1fr}
      .row{flex-direction:column;align-items:stretch}
      .row.cols-2{grid-template-columns:1fr}
      .row.cols-3{grid-template-columns:1fr}
      .row.cols-contact{grid-template-columns:1fr}
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --card: #1e293b;
        --border: #334155;
        --ink: #f1f5f9;
        --muted: #94a3b8;
      }
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .modal{animation:fadeIn 0.2s ease-out}

    /* Improve accessibility */
    .btn:focus-visible,
    .field input:focus-visible,
    .field select:focus-visible,
    .field textarea:focus-visible {
      outline: 2px solid var(--brand);
      outline-offset: 2px;
    }

    /* Loading states */
    .loading-state {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Better error states */
    .field.error input,
    .field.error select,
    .field.error textarea {
      border-color: var(--warn);
      background-color: #fef2f2;
    }

    .field .error-message {
      color: var(--warn);
      font-size: 12px;
      margin-top: 4px;
    }

  </style>
</head>

<body>
  <header>
    <div class="left">
      <img src="logo.webp" alt="KidBike e. V." style="display:none;" id="logoImg">
      <h1 id="headerTitle">Verkehrsschule buchen</h1>
    </div>

    <div class="controls">
      <label for="langSelect" id="langLabel">Sprache:</label>
      <select id="langSelect">
        <option value="de">Deutsch</option>
        <option value="en">English</option>
      </select>

      <label for="schoolSelect" id="schoolLabel">Standort:</label>
      <select id="schoolSelect">
        <option value="" id="schoolSelectPlaceholder">Verkehrsschule wählen...</option>
      </select>
    </div>
  </header>

  <div class="intro">
    <p id="introText">Wähle eine Verkehrsschule aus der Liste, um den Kalender zu laden und eine Buchungsanfrage zu stellen.</p>
  </div>

  <div id="calendar">
    <div id="calendarLoading" class="loading">Kalender wird geladen...</div>
  </div>

  <button class="mobile-add" id="mobileAddBtn" aria-label="Neue Buchung">+</button>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <button class="close-x" id="modalClose" aria-label="Schließen">&times;</button>
      
      <h3 id="modalTitle">Neue Anfrage erstellen</h3>
      <p id="modalDesc" class="muted">Füllen Sie das Formular aus, um eine Buchungsanfrage zu senden.</p>

      <div class="steps" id="stepsText">Schritt 1 von 2: Datum & Zeit</div>

      <!-- Step 1: DateTime & Pricing -->
      <div id="step1" class="grid">
        <div class="field required">
          <label for="fFrom" id="labelFrom">Von</label>
          <input type="datetime-local" id="fFrom" required>
        </div>
        <div class="field required">
          <label for="fTo" id="labelTo">Bis</label>
          <input type="datetime-local" id="fTo" required>
        </div>
        <div class="field required">
          <label for="fPersons" id="labelPersons">Anzahl Personen</label>
          <input type="number" id="fPersons" min="1" max="150" required>
        </div>

        <!-- Extras (dynamically filled) -->
        <div class="field field--extras">
          <label id="labelExtras">Extras</label>
          <div id="extrasContainer" class="extras"></div>
        </div>

        <!-- Price Preview -->
        <div class="price">
          <div class="pill" id="priceValue">–</div>
          <span class="toggle" id="priceToggle" style="display:none">Details</span>
        </div>

        <!-- Price Breakdown -->
        <div id="priceBreakdown" class="breakdown">
          <div class="row"><span id="bdBaseLabel" class="muted">Basis</span><span id="bdBase">–</span></div>
          <div class="row"><span id="bdPersonsLabel" class="muted">Personen-Staffel</span><span id="bdPersons">–</span></div>
          <div class="row">
            <span class="muted tooltip-wrap">
              <span id="bdTimeLabel">Zeit-Zuschlag</span>
              <span id="timeInfo" class="tooltip-icon" aria-haspopup="dialog" aria-expanded="false" tabindex="0">?</span>
              <div id="timeInfoPopover" class="popover" role="dialog" aria-hidden="true"></div>
            </span>
            <span id="bdTime">–</span>
          </div>
          <div class="row"><span id="bdExtrasLabel" class="muted">Extras</span><span id="bdExtras">–</span></div>
          
          <!-- NEW: Kaution (only visible for WA) -->
          <div class="row" id="bdDepositRow" style="display:none">
            <span class="muted">Kaution</span><span id="bdDeposit">–</span>
          </div>

          <div class="row total"><span id="bdTotalLabel">Summe</span><span id="bdTotal">–</span></div>
        </div>
      </div>

      <!-- Step 2: Personal Info -->
      <div id="step2" class="grid-1" style="display:none">
        <div class="row cols-3">
          <div class="field required">
            <label for="fTitle" id="labelTitle">Anrede</label>
            <select id="fTitle" required>
              <option value="">Bitte wählen</option>
              <option value="Herr">Herr</option>
              <option value="Frau">Frau</option>
              <option value="Divers">Divers</option>
            </select>
          </div>
          <div class="field required">
            <label for="fFirstName" id="labelFirstName">Vorname</label>
            <input type="text" id="fFirstName" required>
          </div>
          <div class="field required">
            <label for="fLastName" id="labelLastName">Nachname</label>
            <input type="text" id="fLastName" required>
          </div>
        </div>

        <div class="row cols-contact">
          <div class="field required">
            <label for="fEmail" id="labelEmail">E-Mail</label>
            <input type="email" id="fEmail" required>
          </div>
          <div class="field required">
            <label for="fDialCode" id="labelDialCode">Vorwahl</label>
            <select id="fDialCode" required>
              <option value="+49">+49 (DE)</option>
              <option value="+43">+43 (AT)</option>
              <option value="+41">+41 (CH)</option>
              <option value="+33">+33 (FR)</option>
              <option value="+31">+31 (NL)</option>
              <option value="+32">+32 (BE)</option>
              <option value="+45">+45 (DK)</option>
              <option value="+46">+46 (SE)</option>
              <option value="+47">+47 (NO)</option>
              <option value="+48">+48 (PL)</option>
              <option value="+420">+420 (CZ)</option>
              <option value="+36">+36 (HU)</option>
              <option value="+44">+44 (GB)</option>
              <option value="+1">+1 (US/CA)</option>
              <option value="+39">+39 (IT)</option>
              <option value="+34">+34 (ES)</option>
              <option value="+351">+351 (PT)</option>
            </select>
          </div>
          <div class="field required">
            <label for="fPhone" id="labelPhone">Telefon</label>
            <input type="tel" id="fPhone" required>
          </div>
        </div>

        <div class="row cols-2">
          <div class="field">
            <label for="fEventType" id="labelEventType">Art der Feier</label>
            <select id="fEventType">
              <option value="">Bitte wählen</option>
              <option value="Kindergeburtstag">Kindergeburtstag</option>
              <option value="Erwachsenengeburtstag">Erwachsenengeburtstag</option>
              <option value="Hochzeit">Hochzeit</option>
              <option value="Firmenfeier">Firmenfeier</option>
              <option value="Familienfeier">Familienfeier</option>
              <option value="Vereinsfeier">Vereinsfeier</option>
              <option value="Schulklassenfeier">Schulklassenfeier</option>
              <option value="Jugendgruppe">Jugendgruppe</option>
              <option value="Workshop">Workshop</option>
              <option value="Seminar">Seminar</option>
              <option value="Kurs">Kurs</option>
              <option value="Sonstiges">Sonstiges</option>
            </select>
          </div>
          <div class="field" id="labelBikes" style="display:none">
            <label for="fBikes">Nutzung Fahrräder</label>
            <select id="fBikes">
              <option value="">Bitte wählen</option>
              <option value="Ja">Ja</option>
              <option value="Nein">Nein</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="fMessage" id="labelMessage">Nachricht (optional)</label>
          <textarea id="fMessage" placeholder="Weitere Informationen zu Ihrer Veranstaltung..."></textarea>
        </div>

        <div class="field--checkbox">
          <input type="checkbox" id="fTerms" required>
          <label for="fTerms" id="labelTerms">Ich akzeptiere die wesentlichen Bedingungen</label>
        </div>

        <!-- Terms Summary -->
        <details style="margin:8px 0;padding:8px;border:1px solid var(--border);border-radius:6px">
          <summary id="termsSummary" style="cursor:pointer;font-weight:600;font-size:13px">Wesentliche Bedingungen</summary>
          <ul id="termsList" style="margin:8px 0 0;padding-left:20px;font-size:12px;color:var(--muted)"></ul>
        </details>
      </div>

      <!-- Navigation & Submit -->
      <div class="row" style="margin-top:12px;gap:8px">
        <button type="button" id="btnBack" class="btn secondary" style="display:none">Zurück</button>
        <button type="button" id="btnNext" class="btn">Weiter</button>
        <button type="button" id="btnSubmit" class="btn" style="display:none">Anfrage senden</button>
      </div>

      <!-- Sticky Bar -->
      <div id="stickyBar" class="sticky-bar">
        <div class="sum">
          <span id="stickySum">Summe: <b id="stickyTotal">–</b></span>
          <span id="extrasRunning" style="display:none"></span>
        </div>
        <div class="checkline" style="display:none">
          <input type="checkbox" id="stickyTerms" style="margin:0">
          <label for="stickyTerms" style="font-size:11px;margin:0" id="stickyTermsLabel">Bedingungen akzeptiert</label>
        </div>
        <button type="button" id="btnSubmit" class="btn" style="display:none">Anfrage senden</button>
      </div>
    </div>
  </div>

  <!-- Success Overlay -->
  <div id="successOverlay" class="success-overlay">
    <div class="success-content">
      <h3 id="successTitle">✓ Anfrage erfolgreich gesendet!</h3>
      <p id="successMessage">Ihre Anfrage wurde erfolgreich übermittelt. Sie erhalten in Kürze eine Bestätigung per E-Mail.</p>
      <div id="successSummary" class="summary"></div>
      <button class="btn" id="successOk">OK</button>
    </div>
  </div>

  <script>
    /* Global Variables */
    let calendar = null;
    let currentKey = '';
    let CURRENT_PRICE = null;

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdDJ-3V3mU0hnGT1fYXCOEqzl8bLQGfggKEGCMVYSxMQQOCHh8MiVhFfn-L_vZAKOu/exec';

    /* DOM References */
    const logoImg = document.getElementById('logoImg');
    const langSelect = document.getElementById('langSelect');
    const schoolSelect = document.getElementById('schoolSelect');
    const modalBack = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');
    const mobileAddBtn = document.getElementById('mobileAddBtn');

    // Form fields
    const fFrom = document.getElementById('fFrom');
    const fTo = document.getElementById('fTo');
    const fPersons = document.getElementById('fPersons');
    const fTitle = document.getElementById('fTitle');
    const fFirstName = document.getElementById('fFirstName');
    const fLastName = document.getElementById('fLastName');
    const fEmail = document.getElementById('fEmail');
    const fDialCode = document.getElementById('fDialCode');
    const fPhone = document.getElementById('fPhone');
    const fEventType = document.getElementById('fEventType');
    const fBikes = document.getElementById('fBikes');
    const fMessage = document.getElementById('fMessage');
    const fTerms = document.getElementById('fTerms');

    // Navigation
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');

    // Price elements
    const priceValue = document.getElementById('priceValue');
    const priceToggle = document.getElementById('priceToggle');
    const priceBreakdown = document.getElementById('priceBreakdown');
    const bdBaseLabel = document.getElementById('bdBaseLabel');
    const bdBase = document.getElementById('bdBase');
    const bdPersonsLabel = document.getElementById('bdPersonsLabel');
    const bdPersons = document.getElementById('bdPersons');
    const bdTime = document.getElementById('bdTime');
    const bdExtras = document.getElementById('bdExtras');
    const bdTotal = document.getElementById('bdTotal');
    const bdDepositRow = document.getElementById('bdDepositRow');
    const bdDeposit = document.getElementById('bdDeposit');

    // Sticky bar
    const stickyBar = document.getElementById('stickyBar');
    const stickyTotal = document.getElementById('stickyTotal');
    const stickyTerms = document.getElementById('stickyTerms');

    // Success overlay
    const successOverlay = document.getElementById('successOverlay');
    const successOk = document.getElementById('successOk');

    /* I18N */
    const I18N = {
      de: {
        // Header
        headerTitle: 'Verkehrsschule buchen',
        langLabel: 'Sprache:',
        schoolLabel: 'Standort:',
        schoolSelectPlaceholder: 'Verkehrsschule wählen...',

        // Intro
        introText: 'Wähle eine Verkehrsschule aus der Liste, um den Kalender zu laden und eine Buchungsanfrage zu stellen.',

        // Modal
        modalTitle: 'Neue Anfrage erstellen',
        modalDesc: 'Füllen Sie das Formular aus, um eine Buchungsanfrage zu senden.',
        step1of2: 'Schritt 1 von 2: Datum & Zeit',
        step2of2: 'Schritt 2 von 2: Kontaktdaten',

        // Form labels
        labelFrom: 'Von',
        labelTo: 'Bis',
        labelPersons: 'Anzahl Personen',
        labelExtras: 'Extras',
        labelTitle: 'Anrede',
        labelFirstName: 'Vorname',
        labelLastName: 'Nachname',
        labelEmail: 'E-Mail',
        labelDialCode: 'Vorwahl',
        labelPhone: 'Telefon',
        labelEventType: 'Art der Feier',
        labelBikes: 'Nutzung Fahrräder',
        labelMessage: 'Nachricht (optional)',
        labelTerms: 'Ich akzeptiere die wesentlichen Bedingungen',

        // Buttons
        btnBack: 'Zurück',
        btnNext: 'Weiter',
        btnSend: 'Anfrage senden',

        // Price
        priceOnReq: 'Preis nach Vereinbarung',
        bdBase: hoursLabel => `Basis (${hoursLabel})`,
        bdPersons: pplLabel => `Personen-Staffel (${pplLabel})`,
        bdTimeLabel: 'Zeit-Zuschlag',
        bdExtrasLabel: 'Extras',
        bdTotalLabel: 'Summe',
        bdNoExtras: 'keine',

        // Success
        successTitle: '✓ Anfrage erfolgreich gesendet!',
        successMessage: 'Ihre Anfrage wurde erfolgreich übermittelt. Sie erhalten in Kürze eine Bestätigung per E-Mail.',
        successOk: 'OK',

        // Calendar
        loadingCalendar: 'Kalender wird geladen...',

        // Terms
        termsSummary: 'Wesentliche Bedingungen',
        terms: [
          'Die Nutzung erfolgt ausschließlich zu den angegebenen Zeiten.',
          'Parallel-Veranstaltungen durch andere Gruppen sind möglich.',
          'Schäden sind umgehend zu melden und können in Rechnung gestellt werden.',
          'Die Räumlichkeiten sind in sauberem Zustand zu hinterlassen.',
          'Rauchen ist in den Räumlichkeiten untersagt.',
          'Eine Absage ist bis 48 Stunden vor Beginn kostenlos möglich.',
          'Bei kurzfristiger Absage wird eine Bearbeitungsgebühr erhoben.'
        ]
      },

      en: {
        // Header
        headerTitle: 'Book Traffic School',
        langLabel: 'Language:',
        schoolLabel: 'Location:',
        schoolSelectPlaceholder: 'Choose traffic school...',

        // Intro
        introText: 'Select a traffic school from the list to load the calendar and submit a booking request.',

        // Modal
        modalTitle: 'Create New Request',
        modalDesc: 'Fill out the form to send a booking request.',
        step1of2: 'Step 1 of 2: Date & Time',
        step2of2: 'Step 2 of 2: Contact Details',

        // Form labels
        labelFrom: 'From',
        labelTo: 'To',
        labelPersons: 'Number of People',
        labelExtras: 'Extras',
        labelTitle: 'Title',
        labelFirstName: 'First Name',
        labelLastName: 'Last Name',
        labelEmail: 'Email',
        labelDialCode: 'Country Code',
        labelPhone: 'Phone',
        labelEventType: 'Type of Event',
        labelBikes: 'Bicycle Usage',
        labelMessage: 'Message (optional)',
        labelTerms: 'I accept the essential terms',

        // Buttons
        btnBack: 'Back',
        btnNext: 'Continue',
        btnSend: 'Send Request',

        // Price
        priceOnReq: 'Price on request',
        bdBase: hoursLabel => `Base (${hoursLabel})`,
        bdPersons: pplLabel => `People tier (${pplLabel})`,
        bdTimeLabel: 'Time Surcharge',
        bdExtrasLabel: 'Extras',
        bdTotalLabel: 'Total',
        bdNoExtras: 'none',

        // Success
        successTitle: '✓ Request sent successfully!',
        successMessage: 'Your request has been submitted successfully. You will receive a confirmation email shortly.',
        successOk: 'OK',

        // Calendar
        loadingCalendar: 'Loading calendar...',

        // Terms
        termsSummary: 'Essential Terms',
        terms: [
          'Use is exclusively during the specified times.',
          'Parallel events by other groups are possible.',
          'Damages must be reported immediately and may be charged.',
          'The premises must be left in a clean condition.',
          'Smoking is prohibited in the premises.',
          'Cancellation is free of charge up to 48 hours before the start.',
          'A processing fee will be charged for short-notice cancellations.'
        ]
      }
    };

    /* Pricing Configuration with WA Support */
    const PRICING = {
      WE: {
        tiers: [
          { maxMin: 240, base: 140, hoursLabel: 'bis 4 Std.' },
          { maxMin: 480, base: 200, hoursLabel: '4–8 Std.' },
          { maxMin: 720, base: 280, hoursLabel: '8–12 Std.' },
          { maxMin: 960, base: 380, hoursLabel: '12–16 Std.' }
        ],
        personTiers: [
          { max: 25, mult: 1.0, label: '≤25' },
          { max: 45, mult: 1.4, label: '26–45' },
          { max: 100, mult: 2.0, label: '46–100' }
        ],
        surcharge(start, end) {
          const hour = start.getHours();
          return (hour < 8 || hour >= 18) ? 20 : 0;
        },
        extras: [
          { label: 'Catering-Paket Standard', labelEn: 'Standard Catering Package', price: 45 },
          { label: 'Catering-Paket Premium', labelEn: 'Premium Catering Package', price: 85 },
          { label: 'Getränke-Service', labelEn: 'Beverage Service', price: 25 },
          { label: 'Technik-Paket (Beamer, Sound)', labelEn: 'Tech Package (Projector, Sound)', price: 40 },
          { label: 'Erweiterte Reinigung', labelEn: 'Extended Cleaning', price: 30 }
        ]
      },

      WI: {
        tiers: [
          { maxMin: 240, base: 120, hoursLabel: 'bis 4 Std.' },
          { maxMin: 480, base: 180, hoursLabel: '4–8 Std.' },
          { maxMin: 720, base: 240, hoursLabel: '8–12 Std.' },
          { maxMin: 960, base: 320, hoursLabel: '12–16 Std.' }
        ],
        personTiers: [
          { max: 25, mult: 1.0, label: '≤25' },
          { max: 45, mult: 1.3, label: '26–45' },
          { max: 100, mult: 1.8, label: '46–100' }
        ],
        surcharge(start, end) {
          const hour = start.getHours();
          return (hour < 8 || hour >= 18) ? 15 : 0;
        },
        extras: [
          { label: 'Catering-Service', labelEn: 'Catering Service', price: 35 },
          { label: 'Getränke-Paket', labelEn: 'Beverage Package', price: 20 },
          { label: 'Technik-Support', labelEn: 'Technical Support', price: 30 },
          { label: 'Zusatz-Reinigung', labelEn: 'Additional Cleaning', price: 25 }
        ]
      },

      WA: {
        // No extras for WA
        extras: [],

        // Deposit rule for WA: 50 € bis einschl. 45 Pers., sonst 70 €
        cautionFn(persons){
          const p = Number(persons || 0);
          if (!p) return null;
          return (p <= 45) ? 50 : 70;
        },

        // Custom pricing function for WA (replaces generic tiers+personTiers)
        // Rules:
        // - bis einschließlich 12 Std.:
        //      ≤45 Pers.: 140 €   |   ≥46 Pers.: 220 €
        // - 12–16 Std.:
        //      ≤45 Pers.: 200 €   |   ≥46 Pers.: 310 €
        // - >16 Std.: Preis nach Vereinbarung (no fixed amount)
        customPrice(start, end, persons){
          const ms = (end - start);
          if (!start || !end || ms <= 0) return null;

          const hours = ms / 3600000;
          const p = Number(persons || 0);

          // More than 16 hours? => no fixed price (show "Preis nach Vereinbarung")
          if (hours > 16) {
            return {
              price: null,                           // => UI shows "Preis nach Vereinbarung"
              tierLabel: "über 16 Std.",
              personsLabel: p ? (p <= 45 ? "≤45" : "≥46") : "",
              caution: this.cautionFn(p)             // still show deposit
            };
          }

          const short = hours <= 12;
          const tierLabel = short ? "bis 12 Std." : "12–16 Std.";
          const personsLabel = p ? (p <= 45 ? "≤45" : "≥46") : "";

          let base;
          if (p <= 45) {
            base = short ? 140 : 200;
          } else {
            base = short ? 220 : 310;
          }

          return {
            price: base,              // total without extras (WA has no extras)
            base,
            personsDelta: 0,
            timeSurcharge: 0,
            tierLabel,
            personsLabel,
            caution: this.cautionFn(p)
          };
        }
      }
    };

    /* Helper Functions */
    function euro(amount) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR'
      }).format(amount);
    }

    function parseLocalDT(str) {
      if (!str) return null;
      return new Date(str);
    }

    function debounce(fn, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    /* Terms Helper Function */
    function getTermsForSchool(lang, key){
      const base = (I18N[lang] || I18N.de).terms.slice();

      if (key === 'WA') {
        // For Wassertorplatz: NO Parallel events rule
        const filtered = base.filter(t => !/Parallel/i.test(t));

        // Add key handover rule
        const extraDe = "Schlüssel-Übergabe und -Rückgabe sind vorab mit der Mitarbeiter*in vor Ort abzustimmen.";
        const extraEn = "Key handover and return must be arranged in advance with the staff on site.";

        filtered.push(lang === 'en' ? extraEn : extraDe);
        return filtered;
      }

      // Default: unchanged
      return base;
    }

    /* Price Updates */
    function updatePricePreview(){
      const L = I18N[langSelect.value] || I18N.de;
      const start   = parseLocalDT(fFrom.value);
      const end     = parseLocalDT(fTo.value);
      const persons = Number(fPersons.value || 0);
      CURRENT_PRICE = null;

      // reset UI
      const showPriceOnReq = ()=> {
        priceValue.textContent = L.priceOnReq;
        bdBaseLabel.textContent = (langSelect.value==='en' ? 'Base' : 'Basis');
        bdBase.textContent = '–';
        bdPersonsLabel.textContent = (langSelect.value==='en' ? 'People tier' : 'Personen-Staffel');
        bdPersons.textContent = (langSelect.value==='en' ? '€0.00' : '0,00 €');
        bdTime.textContent = (langSelect.value==='en' ? '€0.00' : '0,00 €');
        bdExtras.textContent = (L.bdNoExtras || (langSelect.value==='en' ? 'none' : 'keine'));
        bdTotal.textContent = '–';
        // deposit
        if (bdDepositRow) bdDepositRow.style.display = 'none';
        priceBreakdown.style.display = 'block';
        updateSticky();
      };

      if (!(start && end) || end <= start){
        priceValue.textContent = '–';
        priceBreakdown.style.display = 'none';
        hidePopover();
        updateSticky();
        return;
      }

      const cfg = PRICING[currentKey] || PRICING.WE;

      // ======= Path A: customPrice (e.g. WA) =======
      if (typeof cfg.customPrice === 'function') {
        const out = cfg.customPrice(start, end, persons);

        if (!out || out.price === null) {
          // >16h for WA => price on request, but show deposit (if calculated)
          showPriceOnReq();
          if (cfg.cautionFn) {
            const depo = cfg.cautionFn(persons);
            if (depo && bdDepositRow) {
              bdDeposit.textContent = euro(depo);
              bdDepositRow.style.display = '';
            }
          }
          CURRENT_PRICE = {
            currency: 'EUR',
            tierHours: out?.tierLabel || '',
            personsMultiplier: 1,
            personsLabel: out?.personsLabel || '',
            base: null,
            personsDelta: 0,
            timeSurcharge: 0,
            extrasCount: 0,
            extrasCost: 0,
            total: null,
            extrasSelected: [],
            caution: out?.caution ?? (cfg.cautionFn ? cfg.cautionFn(persons) : null)
          };
          updateSticky();
          return;
        }

        // WA has no extras; time surcharge = 0
        const total = out.price;

        priceValue.textContent = euro(total);
        bdBaseLabel.textContent = (langSelect.value==='en'
          ? `Base (${out.tierLabel || ''})`
          : `Basis (${out.tierLabel || ''})`);
        bdBase.textContent = euro(out.base ?? total);

        bdPersonsLabel.textContent = (langSelect.value==='en'
          ? `People tier (${out.personsLabel || ''})`
          : `Personen-Staffel (${out.personsLabel || ''})`);
        bdPersons.textContent = (langSelect.value==='en' ? '€0.00' : '0,00 €');

        bdTime.textContent = (langSelect.value==='en' ? '€0.00' : '0,00 €');

        // extras
        bdExtras.textContent = (L.bdNoExtras || (langSelect.value==='en' ? 'none' : 'keine'));

        bdTotal.textContent = euro(total);

        // Show deposit (not added to total)
        if (cfg.cautionFn || typeof out.caution !== 'undefined') {
          const depo = (typeof out.caution !== 'undefined') ? out.caution : cfg.cautionFn(persons);
          if (depo && bdDepositRow) {
            bdDeposit.textContent = euro(depo);
            bdDepositRow.style.display = '';
          } else if (bdDepositRow) {
            bdDepositRow.style.display = 'none';
          }
        }

        CURRENT_PRICE = {
          currency: 'EUR',
          tierHours: out.tierLabel || '',
          personsMultiplier: 1,
          personsLabel: out.personsLabel || '',
          base: Number(out.base ?? total),
          personsDelta: 0,
          timeSurcharge: 0,
          extrasCount: 0,
          extrasCost: 0,
          total: Number(total),
          extrasSelected: [],
          caution: (typeof out.caution !== 'undefined') ? out.caution : (cfg.cautionFn ? cfg.cautionFn(persons) : null)
        };

        priceBreakdown.style.display = 'block';
        updateSticky();
        return;
      }

      // ======= Path B: generic tiers/personTiers (WE/WI) =======
      // (unchanged logic – your existing code, slightly condensed)
      const totalMin = Math.round((end - start) / 60000);
      const tier = (cfg.tiers || []).find(t => totalMin <= t.maxMin) || null;

      let mult = null, pplLabel = ">100";
      for (const pt of (cfg.personTiers || [])){
        if (persons <= pt.max){ mult = pt.mult; pplLabel = pt.label; break; }
      }

      if(!tier || mult === null){
        showPriceOnReq();
        return;
      }

      const base = tier.base;
      const basePlusPersons = base * mult;
      const personsDelta = basePlusPersons - base;
      const timeAdd = typeof cfg.surcharge === 'function' ? cfg.surcharge(start, end) : 0;

      // extras
      const checked = Array.from(document.querySelectorAll('#extrasContainer input:checked'));
      const extrasCost = checked.reduce((sum, el)=> sum + Number(el.dataset.price||0), 0);
      const extrasSelected = checked.map(el => (langSelect.value==='en' ? el.dataset.labelEn : el.dataset.labelDe) || '');

      const total = basePlusPersons + timeAdd + extrasCost;

      // UI
      priceValue.textContent = euro(total);
      bdBaseLabel.textContent = (langSelect.value==='en' ? I18N.en.bdBase(tier.hoursLabel) : I18N.de.bdBase(tier.hoursLabel));
      bdBase.textContent = euro(base);
      bdPersonsLabel.textContent = (langSelect.value==='en' ? I18N.en.bdPersons(pplLabel) : I18N.de.bdPersons(pplLabel));
      bdPersons.textContent = personsDelta === 0 ? (langSelect.value==='en' ? "€0.00" : "0,00 €") : euro(personsDelta);
      bdTime.textContent = timeAdd ? euro(timeAdd) : (langSelect.value==='en' ? "€0.00" : "0,00 €");
      bdExtras.textContent = extrasCost ? euro(extrasCost) : (L.bdNoExtras || (langSelect.value==='en' ? "none" : "keine"));
      bdTotal.textContent = euro(total);

      // No deposit for WE/WI
      if (bdDepositRow) bdDepositRow.style.display = 'none';

      CURRENT_PRICE = {
        currency: 'EUR',
        tierHours: tier.hoursLabel,
        personsMultiplier: mult,
        personsLabel: pplLabel,
        base: Number(base),
        personsDelta: Number(personsDelta),
        timeSurcharge: Number(timeAdd),
        extrasCount: checked.length,
        extrasCost: Number(extrasCost),
        total: Number(total),
        extrasSelected
      };

      priceBreakdown.style.display = 'block';
      updateSticky();

      const extrasRunning = document.getElementById('extrasRunning');
      if (extrasRunning) extrasRunning.textContent = `Extras: ${euro(extrasCost)}`;
    }

    function updateSticky() {
      if (CURRENT_PRICE && CURRENT_PRICE.total !== null) {
        stickyTotal.textContent = euro(CURRENT_PRICE.total);
      } else {
        stickyTotal.textContent = '–';
      }
    }

    function renderExtrasForSchool(key) {
      const container = document.getElementById('extrasContainer');
      const cfg = PRICING[key] || PRICING.WE;
      
      container.innerHTML = '';
      
      if (cfg.extras && cfg.extras.length > 0) {
        cfg.extras.forEach((extra, i) => {
          const label = document.createElement('label');
          label.className = 'badge';
          
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.dataset.price = extra.price;
          input.dataset.labelDe = extra.label;
          input.dataset.labelEn = extra.labelEn || extra.label;
          input.addEventListener('change', updatePricePreview);
          
          const span = document.createElement('span');
          span.textContent = langSelect.value === 'en' ? (extra.labelEn || extra.label) : extra.label;
          
          const price = document.createElement('span');
          price.className = 'price';
          price.textContent = euro(extra.price);
          
          label.appendChild(input);
          label.appendChild(span);
          label.appendChild(price);
          container.appendChild(label);
        });
      }
      
      // Show/hide extras field
      document.querySelector('.field--extras').style.display =
        (cfg.extras && cfg.extras.length) ? '' : 'none';
    }

    /* Calendar Functions */
    async function discoverSchools() {
      try {
        const response = await fetch(`${APPS_SCRIPT_URL}?type=schools`);
        const schools = await response.json();
        
        schoolSelect.innerHTML = '<option value="">' + 
          (I18N[langSelect.value] || I18N.de).schoolSelectPlaceholder + 
          '</option>';
        
        schools.forEach(school => {
          const option = document.createElement('option');
          option.value = school.key;
          option.textContent = school.name;
          if (school.disabled) {
            option.disabled = true;
            option.className = 'disabled';
          }
          schoolSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading schools:', error);
      }
    }

    async function loadCalendar(key) {
      currentKey = key;
      const calendarDiv = document.getElementById('calendar');
      
      if (!key) {
        calendarDiv.innerHTML = '<div id="calendarLoading" class="loading">' +
          (I18N[langSelect.value] || I18N.de).loadingCalendar + 
          '</div>';
        if (calendar) {
          calendar.destroy();
          calendar = null;
        }
        return;
      }

      calendarDiv.innerHTML = '<div id="calendarLoading" class="loading">' +
        (I18N[langSelect.value] || I18N.de).loadingCalendar + 
        '</div>';

      try {
        const response = await fetch(`${APPS_SCRIPT_URL}?type=calendar&school=${encodeURIComponent(key)}`);
        const events = await response.json();

        if (calendar) {
          calendar.destroy();
        }

        calendar = new FullCalendar.Calendar(calendarDiv, {
          initialView: 'timeGridWeek',
          locale: langSelect.value,
          height: 'auto',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          slotMinTime: '08:00',
          slotMaxTime: '22:00',
          allDaySlot: false,
          selectable: true,
          selectMirror: true,
          events: events.map(event => ({
            ...event,
            classNames: event.status === 'busy' ? ['busy'] : []
          })),
          select: function(info) {
            openModal(info.start, info.end);
            calendar.unselect();
          },
          eventClick: function(info) {
            if (!info.event.classNames.includes('busy')) {
              openModal(info.event.start, info.event.end);
            }
          }
        });

        calendar.render();
        calendarDiv.classList.add('loaded');

        // Load holds
        const holdsResponse = await fetch(`${APPS_SCRIPT_URL}?type=holds&school=${encodeURIComponent(key)}`);
        if (holdsResponse.ok) {
          const holds = await holdsResponse.json();
          holds.forEach(hold => {
            calendar.addEvent({
              title: langSelect.value === 'en' 
                ? 'Tentative — awaiting confirmation' 
                : 'Vorläufig reserviert — Bestätigung ausstehend',
              start: new Date(hold.start),
              end: new Date(hold.end),
              editable: false,
              overlap: true,
              classNames: ['tentative']
            });
          });
        }

      } catch (error) {
        console.error('Error loading calendar:', error);
        calendarDiv.innerHTML = '<div class="loading">Fehler beim Laden des Kalenders</div>';
      }

      // Render extras and update pricing for this school
      renderExtrasForSchool(key);
      updatePricePreview();

      // Refresh terms for the selected school
      (function refreshTerms(){
        const termsList = document.getElementById('termsList');
        if (!termsList) return;
        const L = I18N[langSelect.value] || I18N.de;
        document.getElementById('termsSummary').textContent = L.termsSummary;
        termsList.innerHTML = "";
        getTermsForSchool(langSelect.value, currentKey).forEach(t => {
          const li = document.createElement('li'); 
          li.textContent = t; 
          termsList.appendChild(li);
        });
      })();
    }

    /* Modal Functions */
    function openModal(start, end) {
      // Set default date/time values
      if (start) {
        fFrom.value = start.toISOString().slice(0, 16);
      }
      if (end) {
        fTo.value = end.toISOString().slice(0, 16);
      }

      // Reset form
      resetForm();
      
      // Show step 1
      showStep(1);
      
      // Show modal
      modalBack.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Update pricing
      updatePricePreview();
    }

    function closeModal() {
      modalBack.style.display = 'none';
      document.body.style.overflow = '';
      resetForm();
      hidePopover();
    }

    function resetForm() {
      // Clear form fields
      fPersons.value = '';
      fTitle.value = '';
      fFirstName.value = '';
      fLastName.value = '';
      fEmail.value = '';
      fDialCode.value = '+49';
      fPhone.value = '';
      fEventType.value = '';
      fBikes.value = '';
      fMessage.value = '';
      fTerms.checked = false;
      stickyTerms.checked = false;

      // Clear extras
      document.querySelectorAll('#extrasContainer input:checked').forEach(input => {
        input.checked = false;
      });

      // Reset pricing
      CURRENT_PRICE = null;
      updatePricePreview();
    }

    function showStep(step) {
      const L = I18N[langSelect.value] || I18N.de;
      
      if (step === 1) {
        step1.style.display = 'grid';
        step2.style.display = 'none';
        btnBack.style.display = 'none';
        btnNext.style.display = 'inline-block';
        btnSubmit.style.display = 'none';
        document.getElementById('stepsText').textContent = L.step1of2;
        
        // Hide sticky bar elements in step 1
        stickyBar.querySelector('.checkline').style.display = 'none';
        stickyBar.querySelector('#btnSubmit').style.display = 'none';
      } else {
        step1.style.display = 'none';
        step2.style.display = 'block';
        btnBack.style.display = 'inline-block';
        btnNext.style.display = 'none';
        btnSubmit.style.display = 'inline-block';
        document.getElementById('stepsText').textContent = L.step2of2;
        
        // Show sticky bar elements in step 2
        stickyBar.querySelector('.checkline').style.display = 'flex';
        stickyBar.querySelector('#btnSubmit').style.display = 'inline-block';
      }
    }

    function validateStep1() {
      const start = parseLocalDT(fFrom.value);
      const end = parseLocalDT(fTo.value);
      const persons = Number(fPersons.value);

      if (!start || !end) {
        alert(langSelect.value === 'en' ? 'Please select start and end times.' : 'Bitte wählen Sie Start- und Endzeit.');
        return false;
      }

      if (end <= start) {
        alert(langSelect.value === 'en' ? 'End time must be after start time.' : 'Endzeit muss nach der Startzeit liegen.');
        return false;
      }

      if (!persons || persons < 1) {
        alert(langSelect.value === 'en' ? 'Please enter the number of people.' : 'Bitte geben Sie die Anzahl der Personen an.');
        return false;
      }

      return true;
    }

    function validateStep2() {
      const required = [fTitle, fFirstName, fLastName, fEmail, fPhone];
      
      for (const field of required) {
        if (!field.value.trim()) {
          field.focus();
          alert(langSelect.value === 'en' ? 'Please fill in all required fields.' : 'Bitte füllen Sie alle Pflichtfelder aus.');
          return false;
        }
      }

      if (!fTerms.checked && !stickyTerms.checked) {
        alert(langSelect.value === 'en' ? 'Please accept the terms.' : 'Bitte akzeptieren Sie die Bedingungen.');
        return false;
      }

      return true;
    }

    /* I18N */
    function applyI18n() {
      const L = I18N[langSelect.value] || I18N.de;
      
      // Header
      document.getElementById('headerTitle').textContent = L.headerTitle;
      document.getElementById('langLabel').textContent = L.langLabel;
      document.getElementById('schoolLabel').textContent = L.schoolLabel;
      document.getElementById('schoolSelectPlaceholder').textContent = L.schoolSelectPlaceholder;

      // Intro
      document.getElementById('introText').textContent = L.introText;

      // Modal
      document.getElementById('modalTitle').textContent = L.modalTitle;
      document.getElementById('modalDesc').textContent = L.modalDesc;

      // Form labels
      document.getElementById('labelFrom').textContent = L.labelFrom;
      document.getElementById('labelTo').textContent = L.labelTo;
      document.getElementById('labelPersons').textContent = L.labelPersons;
      document.getElementById('labelExtras').textContent = L.labelExtras;
      document.getElementById('labelTitle').textContent = L.labelTitle;
      document.getElementById('labelFirstName').textContent = L.labelFirstName;
      document.getElementById('labelLastName').textContent = L.labelLastName;
      document.getElementById('labelEmail').textContent = L.labelEmail;
      document.getElementById('labelDialCode').textContent = L.labelDialCode;
      document.getElementById('labelPhone').textContent = L.labelPhone;
      document.getElementById('labelEventType').textContent = L.labelEventType;
      document.getElementById('labelBikes').textContent = L.labelBikes;
      document.getElementById('labelMessage').textContent = L.labelMessage;
      document.getElementById('labelTerms').textContent = L.labelTerms;

      // Buttons
      document.getElementById('btnBack').textContent = L.btnBack;
      document.getElementById('btnNext').textContent = L.btnNext;
      document.getElementById('stickyTermsLabel').textContent = L.labelTerms;

      // Price breakdown
      document.getElementById('bdTimeLabel').textContent = L.bdTimeLabel;
      document.getElementById('bdExtrasLabel').textContent = L.bdExtrasLabel;
      document.getElementById('bdTotalLabel').textContent = L.bdTotalLabel;

      // Update terms using helper function
      const termsList = document.getElementById('termsList');
      termsList.innerHTML = "";
      const termsToRender = getTermsForSchool(langSelect.value, currentKey);
      termsToRender.forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        termsList.appendChild(li);
      });

      // Update extras labels if any
      document.querySelectorAll('#extrasContainer .badge').forEach((badge, i) => {
        const input = badge.querySelector('input');
        const span = badge.querySelector('span:not(.price)');
        if (input && span) {
          span.textContent = langSelect.value === 'en' ? input.dataset.labelEn : input.dataset.labelDe;
        }
      });

      // Update calendar if exists
      if (calendar) {
        calendar.setOption('locale', langSelect.value);
      }

      // Update loading text
      const loading = document.getElementById('calendarLoading');
      if (loading) {
        loading.firstChild.nodeValue = L.loadingCalendar;
      }

      // Update pricing
      updatePricePreview();

      // Update submit button text
      const submitBtns = document.querySelectorAll('#btnSubmit');
      submitBtns.forEach(btn => {
        btn.textContent = L.btnSend;
      });
    }

    /* Submission */
    async function submitForm() {
      if (!validateStep2()) return;

      const submitBtns = document.querySelectorAll('#btnSubmit');
      submitBtns.forEach(btn => {
        btn.classList.add('loading');
        btn.disabled = true;
      });

      try {
        const payload = {
          school: currentKey,
          from: fFrom.value,
          to: fTo.value,
          persons: fPersons.value,
          title: fTitle.value,
          firstName: fFirstName.value,
          lastName: fLastName.value,
          email: fEmail.value,
          phone: fDialCode.value + fPhone.value,
          eventType: fEventType.value,
          bikes: fBikes.value,
          message: fMessage.value,
          pricing: CURRENT_PRICE,
          extras: Array.from(document.querySelectorAll('#extrasContainer input:checked')).map(input => ({
            label: langSelect.value === 'en' ? input.dataset.labelEn : input.dataset.labelDe,
            price: Number(input.dataset.price)
          })),
          language: langSelect.value
        };

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          showSuccessOverlay(payload);
          closeModal();
        } else {
          throw new Error('Submission failed');
        }
      } catch (error) {
        console.error('Submission error:', error);
        alert(langSelect.value === 'en' ? 'Error sending request. Please try again.' : 'Fehler beim Senden der Anfrage. Bitte versuchen Sie es erneut.');
      } finally {
        submitBtns.forEach(btn => {
          btn.classList.remove('loading');
          btn.disabled = false;
        });
      }
    }

    function showSuccessOverlay(payload) {
      const L = I18N[langSelect.value] || I18N.de;
      
      document.getElementById('successTitle').textContent = L.successTitle;
      document.getElementById('successMessage').textContent = L.successMessage;
      document.getElementById('successOk').textContent = L.successOk;

      // Create summary
      const summary = document.getElementById('successSummary');
      const start = new Date(payload.from);
      const end = new Date(payload.to);
      
      const formatDateTime = (date) => {
        return date.toLocaleDateString(langSelect.value === 'en' ? 'en-GB' : 'de-DE') + 
               ' ' + date.toLocaleTimeString(langSelect.value === 'en' ? 'en-GB' : 'de-DE', {
                 hour: '2-digit',
                 minute: '2-digit'
               });
      };

      let messageRow = "";
      if (payload.message) {
        messageRow = `<div><strong>${langSelect.value === 'en' ? 'Message' : 'Nachricht'}:</strong> ${payload.message}</div>`;
      }

      let depositRow = "";
      if (CURRENT_PRICE && CURRENT_PRICE.caution) {
        depositRow = `<div><strong>Kaution:</strong> ${euro(CURRENT_PRICE.caution)}</div>`;
      }

      summary.innerHTML = `
        <div><strong>${langSelect.value === 'en' ? 'Location' : 'Standort'}:</strong> ${schoolSelect.options[schoolSelect.selectedIndex].text}</div>
        <div><strong>${langSelect.value === 'en' ? 'Date & Time' : 'Datum & Zeit'}:</strong> ${formatDateTime(start)} - ${formatDateTime(end)}</div>
        <div><strong>${langSelect.value === 'en' ? 'People' : 'Personen'}:</strong> ${payload.persons}</div>
        <div><strong>${langSelect.value === 'en' ? 'Contact' : 'Kontakt'}:</strong> ${payload.firstName} ${payload.lastName}</div>
        <div><strong>E-Mail:</strong> ${payload.email}</div>
        <div><strong>${langSelect.value === 'en' ? 'Phone' : 'Telefon'}:</strong> ${payload.phone}</div>
        ${messageRow}
        ${depositRow}
        <div><strong>${langSelect.value === 'en' ? 'Total' : 'Gesamtpreis'}:</strong> ${CURRENT_PRICE && CURRENT_PRICE.total !== null ? euro(CURRENT_PRICE.total) : L.priceOnReq}</div>
      `;

      successOverlay.style.display = 'flex';
    }

    /* Popover Functions */
    function showPopover() {
      const info = document.getElementById('timeInfo');
      const popover = document.getElementById('timeInfoPopover');
      
      if (!info || !popover) return;

      const L = I18N[langSelect.value] || I18N.de;
      popover.textContent = langSelect.value === 'en' 
        ? 'Additional charge for bookings before 8 AM or after 6 PM'
        : 'Zuschlag für Buchungen vor 8 Uhr oder nach 18 Uhr';

      const rect = info.getBoundingClientRect();
      popover.style.left = rect.left + 'px';
      popover.style.top = (rect.bottom + 5) + 'px';
      popover.style.display = 'block';
      
      info.setAttribute('aria-expanded', 'true');
      popover.setAttribute('aria-hidden', 'false');
    }

    function hidePopover() {
      const info = document.getElementById('timeInfo');
      const popover = document.getElementById('timeInfoPopover');
      
      if (!info || !popover) return;

      popover.style.display = 'none';
      info.setAttribute('aria-expanded', 'false');
      popover.setAttribute('aria-hidden', 'true');
    }

    function applyResponsiveView() {
      if (calendar) {
        const width = window.innerWidth;
        if (width < 768) {
          calendar.changeView('timeGridDay');
        } else {
          calendar.changeView('timeGridWeek');
        }
      }
    }

    /* Event Listeners */
    
    // Language & School Selection
    langSelect.addEventListener('change', () => {
      applyI18n();
      if (currentKey) {
        loadCalendar(currentKey);
      }
    });

    schoolSelect.addEventListener('change', (e) => {
      loadCalendar(e.target.value);
    });

    // Modal Controls
    modalClose.addEventListener('click', closeModal);
    mobileAddBtn.addEventListener('click', () => openModal());

    modalBack.addEventListener('click', (e) => {
      if (e.target === modalBack) closeModal();
    });

    // Navigation
    btnNext.addEventListener('click', () => {
      if (validateStep1()) {
        showStep(2);
      }
    });

    btnBack.addEventListener('click', () => {
      showStep(1);
    });

    // Submit
    document.querySelectorAll('#btnSubmit').forEach(btn => {
      btn.addEventListener('click', submitForm);
    });

    // Success overlay
    successOk.addEventListener('click', () => {
      successOverlay.style.display = 'none';
    });

    // Form field updates
    [fFrom, fTo, fPersons].forEach(field => {
      field.addEventListener('input', updatePricePreview);
    });

    // Terms sync
    fTerms.addEventListener('change', () => {
      stickyTerms.checked = fTerms.checked;
    });

    stickyTerms.addEventListener('change', () => {
      fTerms.checked = stickyTerms.checked;
    });

    // Popover
    document.getElementById('timeInfo')?.addEventListener('click', (e) => {
      e.stopPropagation();
      showPopover();
    });

    document.getElementById('timeInfo')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        showPopover();
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#timeInfo')) {
        hidePopover();
      }
    });

    /* ===== embed-size throttle ===== */
    function _sendHeight(){
      var doc=document.documentElement, body=document.body;
      var h=Math.max(body.scrollHeight, body.offsetHeight, doc.clientHeight, doc.scrollHeight, doc.offsetHeight);
      parent.postMessage({ type:'embed-size', height:h }, '*');
    }
    const sendHeightThrottled = debounce(_sendHeight, 120);
    window.addEventListener('load', sendHeightThrottled);
    window.addEventListener('resize', sendHeightThrottled);
    var ro = new ResizeObserver(()=>sendHeightThrottled());
    ro.observe(document.body);

    /* ===== Init ===== */
    (async function init(){
      logoImg.style.display = 'block';
      document.getElementById('calendarLoading').firstChild.nodeValue = (I18N[langSelect.value]||I18N.de).loadingCalendar;
      await discoverSchools();
      applyI18n();
      window.addEventListener('resize', () => applyResponsiveView());
      document.body.classList.toggle('touch', isTouchDevice());
    })();

    /* ===== Auto-refresh holds every 30 seconds ===== */
    setInterval(async () => {
      if (currentKey && calendar) {
        try {
          const r = await fetch(`${APPS_SCRIPT_URL}?type=holds&school=${encodeURIComponent(currentKey)}&v=${Date.now()}`);
          if (r.ok) {
            const arr = await r.json();
            if (Array.isArray(arr)) {
              const holdEvents = arr.map(h => ({
                title: (langSelect.value==='en'
                  ? 'Tentative — awaiting confirmation'
                  : 'Vorläufig reserviert — Bestätigung ausstehend'),
                start: new Date(h.start),
                end:   new Date(h.end),
                editable: false,
                overlap: true,
                classNames: ['tentative']
              }));
              
              // 1) Remove only existing 'tentative' events
              if (Array.isArray(holdEvents) && holdEvents.length) {
                calendar.getEvents()
                  .filter(ev => (ev.classNames || []).includes('tentative'))
                  .forEach(ev => ev.remove());
                holdEvents.forEach(ev => calendar.addEvent(ev));
              }
            }
          }
        } catch(_) {
          // Silently fail - don't disrupt user experience
        }
      }
    }, 30000);

    /* ===== Handle successful submission - reload holds ===== */
    function reloadCalendarAfterSubmission() {
      if (currentKey && calendar) {
        setTimeout(async () => {
          try {
            const r = await fetch(`${APPS_SCRIPT_URL}?type=holds&school=${encodeURIComponent(currentKey)}&v=${Date.now()}`);
            if (r.ok) {
              const arr = await r.json();
              if (Array.isArray(arr)) {
                const holdEvents = arr.map(h => ({
                  title: (langSelect.value==='en'
                    ? 'Tentative — awaiting confirmation'
                    : 'Vorläufig reserviert — Bestätigung ausstehend'),
                  start: new Date(h.start),
                  end:   new Date(h.end),
                  editable: false,
                  overlap: true,
                  classNames: ['tentative']
                }));
                
                // 1) Remove only existing 'tentative' events
                if (Array.isArray(holdEvents) && holdEvents.length) {
                  calendar.getEvents()
                    .filter(ev => (ev.classNames || []).includes('tentative'))
                    .forEach(ev => ev.remove());
                  holdEvents.forEach(ev => calendar.addEvent(ev));
                }
              }
            }
          } catch(_) {
            // Silently fail
          }
        }, 1000);
      }
    }

    /* ===== Window message handler for embed communication ===== */
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'calendar-refresh') {
        if (currentKey) {
          loadCalendar(currentKey);
        }
      }
    });

    /* ===== Keyboard shortcuts ===== */
    document.addEventListener('keydown', (e) => {
      // ESC to close modal
      if (e.key === 'Escape' && modalBack.style.display === 'flex') {
        closeModal();
      }
      
      // CTRL+R or F5 to refresh calendar
      if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
        e.preventDefault();
        if (currentKey) {
          loadCalendar(currentKey);
        }
      }
    });

    /* ===== Touch device enhancements ===== */
    if (isTouchDevice()) {
      // Add touch-specific event handling
      document.addEventListener('touchstart', (e) => {
        if (e.target.closest('.fc-event')) {
          // Add visual feedback for touching events
          e.target.style.opacity = '0.7';
          setTimeout(() => {
            if (e.target.style) e.target.style.opacity = '';
          }, 150);
        }
      });

      // Prevent zoom on double-tap for better UX
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }

    /* ===== Error handling and user feedback ===== */
    window.addEventListener('error', (event) => {
      console.error('Application error:', event.error);
      // Don't show error to user unless it's critical
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

    /* ===== Performance monitoring ===== */
    if ('performance' in window && 'mark' in performance) {
      performance.mark('app-init-complete');
    }

    /* ===== Accessibility enhancements ===== */
    // Announce important changes to screen readers
    function announceToScreenReader(message) {
      const announcement = document.createElement('div');
      announcement.setAttribute('aria-live', 'polite');
      announcement.setAttribute('aria-atomic', 'true');
      announcement.className = 'visually-hidden';
      announcement.textContent = message;
      document.body.appendChild(announcement);
      
      setTimeout(() => {
        document.body.removeChild(announcement);
      }, 1000);
    }

    // Enhance form submission feedback
    const originalShowSuccessOverlay = showSuccessOverlay;
    showSuccessOverlay = function(payload) {
      originalShowSuccessOverlay(payload);
      announceToScreenReader(
        langSelect.value === 'en' 
          ? 'Request submitted successfully'
          : 'Anfrage erfolgreich gesendet'
      );
      reloadCalendarAfterSubmission();
    };

  </script>
</body>
</html>