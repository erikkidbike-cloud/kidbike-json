<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Belegung Verkehrsschulen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    /* Toast volledig uitschakelen */
    #successMsg { display: none !important; }
    
    /* toon vaste + knop op touch devices */
    .touch .mobile-add { display: block; }
    
    /* --- Fix horizontale scroll in embed --- */
    html, body { overflow-x: hidden; width:100%; max-width:100%; }
    header, .intro, #calendar { max-width: 100%; }

    /* FullCalendar binnen viewport houden */
    .fc, .fc-scrollgrid { max-width: 100% !important; }
    .fc .fc-scroller { overflow-x: hidden !important; }
    .fc .fc-scrollgrid table,
    .fc .fc-timegrid-body table { width: 100% !important; table-layout: fixed; }
    .fc .fc-toolbar { flex-wrap: wrap; }

    @media (max-width: 480px) {
      .controls { align-items: stretch; }
      .controls select { min-width: 0; width: 100%; }
    }

    /* compacter: inputs/padding */
    .field input,.field textarea,.field select{padding:7px 10px;min-height:40px}
    .btn{min-height:40px}

    /* waarschuwingen direct onder titel */
    .alert{margin:6px 0 10px;padding:8px 10px;border-radius:8px;font-size:13px}
    .alert.warn{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .alert.note{background:#fef9c3;border:1px solid #fde68a;color:#92400e}

    /* extras chips met prijsbadge en ≥44px touch */
    .badge{min-height:44px;padding:8px 12px;display:inline-flex;align-items:center;gap:6px}
    .badge .price{opacity:.8;font-weight:600;font-size:11px}

    /* prijs "pill" + toggle details */
    .price{display:flex;align-items:center;gap:8px}
    .price .pill{padding:6px 10px;border-radius:999px;background:#0ea5e91a;border:1px solid #bae6fd}
    .price .toggle{cursor:pointer;font-size:12px;text-decoration:underline}

    /* sticky submit-balk */
    .sticky-bar{position:sticky;bottom:0;z-index:5;background:#fff;border-top:1px solid var(--border);
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:0 0 12px 12px}
    .sticky-bar .sum{font-size:13px}
    .sticky-bar .sum b{font-weight:800}

    /* modal: fullscreen sheet op mobiel + body lock */
    @media (max-width:720px){
      .modal{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0;padding:14px}
      .modal h3{font-size:16px}
    }

    /* "X"-sluitknop in header */
    .modal .close-x{position:absolute;top:10px;right:12px;border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer}

    /* submit loading: spinner links en label zichtbaar */
    .btn.loading{color:#fff}
    .btn.loading::before{
      content:"";display:inline-block;width:16px;height:16px;margin-right:8px;
      border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite
    }

    /* focus trap hint (niet zichtbaar) */
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

    /* 1) Remove "Extras: 0 €" */
    #extrasRunning{display:none!important;}

    /* 2) Always show price details in Step 1 (no "Details" button) */
    #priceToggle{display:none!important;}

    /* 3) Fix extras "bubbles" layout/size - make them even more compact */
    .extras .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; min-height:32px; border-radius:999px;
      border:1px solid var(--border); background:#f8fafc; font-size:12px
    }
    .extras .badge input{margin-right:6px}
    .extras .badge .price{font-weight:600;opacity:.7;font-size:11px}

    /* 4) Make Step 2 more compact + put "Art der Feier" and "Nutzung Fahrräder" side-by-side */
    .row.cols-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .row.cols-2{grid-template-columns:1fr} }

    /* 5) Reduce vertical spacing a bit (both steps) */
    .grid{gap:10px}                 /* was 12px */
    .row{gap:6px}                   /* was 8px */
    .field{margin-bottom:8px}       /* was 10px */
    .field label{margin-bottom:3px} /* was 4px */

    /* 7) Hide sticky controls initially */
    #stickyBar .checkline, #btnSubmit { display:none; }

    /* Hide bikes-related UI completely */
    #labelBikes,[for="fBikes"]{display:none!important;}

    /* Name row sizing: short select + two flexible inputs */
    .row.cols-3{display:grid;grid-template-columns:120px 1fr 1fr;gap:10px}

    /* Contact row: email gets more space, dial code is narrow, phone flexes */
    .row.cols-contact{
      display:grid;
      grid-template-columns: 2fr 120px 1.4fr;
      gap:10px;
    }
    @media (max-width:720px){
      .row.cols-contact{grid-template-columns:1fr}
    }

    :root{
      --bg:#f7f9fb; --card:#ffffff; --border:#d8dee6; --ink:#111827;
      --muted:#667085; --brand:#0ea5e9; --busy:#036ba7; --green:#16a34a; --warn:#b91c1c;
      --popover:#0b3552; --popover-bg:#fff; --popover-border:#cfe7f6;
      --warning:#f59e0b; --warning-bg:#fef3c7; --warning-border:#fcd34d;
      --disabled:#9ca3af; --disabled-bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border)}
    header .left{display:flex;align-items:center;gap:12px}
    header img{height:40px;width:auto}
    header h1{font-size:18px;margin:0}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .controls label{color:var(--muted);font-size:14px}
    .controls select{
      appearance:none;font-size:16px;color:var(--ink);
      background:#fff;border:1px solid var(--border);border-radius:10px;
      padding:10px 12px;min-width:220px;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .controls option.disabled{color:var(--disabled)}

    .intro{max-width:1200px;margin:12px auto 0;background:var(--card);border:1px solid var(--border);
      border-radius:10px;padding:10px 14px;color:#1f2937}
    .intro p{margin:4px 0}

    #calendar{max-width:1200px;margin:10px auto;background:var(--card);border:1px solid var(--border);
      border-radius:10px;padding:6px;opacity:0;transition:opacity 0.25s;}
    #calendar.loaded{opacity:1;}
    .fc-theme-standard .fc-scrollgrid,.fc-theme-standard td,.fc-theme-standard th{border-color:var(--border)}
    .fc .fc-button{background:var(--busy);border:1px solid #045983;color:#fff;min-height:40px;font-size:13px;padding:6px 10px}
    .fc .fc-toolbar-title{font-weight:700;font-size:15px}
    .fc-timegrid-slot{min-height:20px;}
    .fc-event.busy{background:var(--busy)!important;border:1px solid #045983!important;color:#fff;}

    .loading{display:flex;align-items:center;justify-content:center;padding:32px;color:var(--muted);}
    .loading::after{content:'';width:18px;height:18px;margin-left:8px;border:2px solid var(--border);border-top:2px solid var(--brand);
      border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    .mobile-add{position:fixed;bottom:16px;right:16px;z-index:40;background:var(--brand);color:white;border:none;border-radius:50%;
      width:52px;height:52px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:22px;cursor:pointer;display:none;}
    .mobile-add:hover{filter:brightness(1.1)}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;overflow-y:auto;padding:16px;}
    .modal{width:100%;max-width:760px;background:var(--card);border-radius:12px;border:1px solid var(--border);padding:16px;position:relative;
      max-height:92vh;overflow-y:auto;margin:auto;box-shadow:0 20px 60px rgba(0,0,0,0.12);}
    .modal h3{margin:0 0 10px;font-size:18px;}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-1{grid-template-columns:1fr}
    .row-compact{display:grid;grid-template-columns:1fr 110px;gap:8px} 
    .row-compact > div{display:grid;grid-template-columns:90px 1fr;gap:8px}
    .row-phone{display:grid;grid-template-columns:140px 1fr;gap:8px}

    .field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(14,165,233,0.1);}
    .field input.error,.field select.error{border-color:var(--warn);}
    .field .error-msg{font-size:12px;color:var(--warn);margin-top:4px;display:none;}
    .field input.error + .error-msg, .field select.error + .error-msg{display:block;}

    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:11px 16px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;font-size:14px}
    .btn:disabled{opacity:0.6;cursor:not-allowed;}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:hover:not(:disabled){filter:brightness(1.1)}
    .btn.danger{background:#fff;border-color:#e5e7eb;color:#374151}
    .btn.danger:hover{background:#f9fafb}

    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .warn{font-size:13px;color:var(--warn);margin-top:6px;display:none;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;}
    .warn.show{display:block;}
    .short-term-warning{font-size:12px;color:var(--warning);margin-top:8px;display:none;background:var(--warning-bg);border:1px solid var(--warning-border);border-radius:8px;padding:8px 10px;}
    .short-term-warning.show{display:block;}

    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#374151;background:#f8fafc;cursor:pointer;user-select:none;transition:all 0.2s;}
    .badge:hover{background:#f1f5f9;}
    .badge input[type="checkbox"]{margin-right:6px;}

    details.summarybox{margin-top:10px;border:1px dashed var(--border);padding:10px;border-radius:10px;background:#fafbfc}
    details.summarybox summary{cursor:pointer;font-weight:700;font-size:14px}

    .breakdown{margin-top:6px;font-size:13px;color:#374141;display:none}
    .breakdown .row{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:1px 0;}
    .breakdown .muted{color:#6b7280}
    .breakdown .total{font-weight:800;border-top:1px dashed var(--border);padding-top:6px;margin-top:6px}

    .tooltip-wrap{position:relative;display:inline-flex;align-items:center}
    .tooltip-icon{cursor:pointer;font-weight:bold;margin-left:6px;user-select:none;background:var(--brand);color:white;border-radius:50%;width:16px;height:16px;
      display:inline-flex;align-items:center;justify-content:center;font-size:10px;}
    .tooltip-icon:hover{filter:brightness(1.1)}
    .popover{position:absolute; top:100%; left:0; transform:translateY(8px); background:var(--popover-bg); color:var(--popover);
      border:1px solid var(--popover-border); border-radius:10px; padding:10px 12px; max-width:320px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      font-size:12px; line-height:1.4; z-index:60; display:none;}
    .popover.show{display:block}
    .popover::after{content:""; position:absolute; top:-6px; left:14px; width:10px; height:10px; background:var(--popover-bg); transform:rotate(45deg); border-left:1px solid var(--popover-border); border-top:1px solid var(--popover-border);}

    .success-msg{position:fixed;top:16px;right:16px;z-index:70;background:#dcfce7;border:1px solid #bbf7d0;color:#166534;
      padding:10px 14px;border-radius:10px;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateX(100%);transition:transform 0.3s;}
    .success-msg.show{transform:translateX(0);}

    .success-overlay{position:fixed; inset:0; z-index:120; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:20px;}
    .success-card{width:min(720px, 96vw); background:#fff; color:#0f172a; border:1px solid var(--border); border-radius:14px; padding:22px; box-shadow:0 24px 80px rgba(0,0,0,0.18);}
    .success-card h2{ margin:0 0 10px; font-size:22px; }
    .success-card p{ margin:6px 0; line-height:1.5; }
    .success-summary{ margin:12px 0 0; padding:12px; border:1px dashed var(--border); border-radius:10px; background:#f8fafc; font-size:15px; }
    .success-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
    .success-actions .btn{ min-width:160px; }

    .start-overlay{position:fixed;inset:0;z-index:110;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;}
    .start-card{width:min(920px, 96vw);background:#fff;border:1px solid var(--border);border-radius:14px;padding:22px;box-shadow:0 24px 80px rgba(0,0,0,.18);}
    .start-card h2{margin:0 0 8px;font-size:22px;}
    .start-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;}
    .school-card{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px;transition:transform .12s, box-shadow .12s, border-color .12s;}
    .school-card:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.06);border-color:#cbd5e1;}
    .school-card .status{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:4px 8px;border-radius:999px;width:max-content;}
    .school-card.disabled{opacity:.55;filter:grayscale(0.2);background:var(--disabled-bg);}
    .school-card.disabled .status{color:#92400e;background:#fef3c7;border-color:#fde68a;}

    /* --- compactere rijen --- */
    .row.cols-3b{grid-template-columns: 1fr 120px 1fr;} 

    /* small form controls */
    .field.sm select,.field.sm input{padding:8px 10px}

    /* checkbox-rij compacter en duidelijk */
    .checkline{display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .checkline input[type="checkbox"]{margin:0}

    /* foutmelding alleen tonen als .error gezet is (zie JS) */
    .field .error-msg{display:none}
    .field input.error + .error-msg,
    .field select.error + .error-msg{display:block}

    @media (max-width:900px){
      .start-grid{grid-template-columns:1fr;}
      .success-actions{flex-direction:column;}
      .success-actions .btn{width:100%;}
    }
    @media (max-width: 720px){
      .grid{grid-template-columns:1fr}
      .row-compact{grid-template-columns:1fr 100px}
      .row-compact > div{grid-template-columns:90px 1fr}
      .row-phone{grid-template-columns:140px 1fr}
      .fc .fc-toolbar-title{ font-size: 14px; }
      .fc .fc-button{ min-height:40px; }
    }

    /* === Always place labels above inputs === */
    .field{
      display:flex;
      flex-direction:column;      /* label on top */
      align-items:stretch;
    }
    .field label{
      display:block;
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      margin:0 0 6px 0;
    }

    /* Consistent control sizing */
    .field input,
    .field select,
    .field textarea{
      width:100%;
      min-height:42px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
    }
    input[type="datetime-local"]{ line-height:normal; }

    /* === Step 1 grid with clear areas === */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      grid-template-areas:
        "school persons"
        "from   to"
        "type   type"
        "extras extras";
    }
    .field--school  { grid-area: school; }
    .field--persons { grid-area: persons; }
    .field--from    { grid-area: from; }
    .field--to      { grid-area: to; }
    .field--type    { grid-area: type; }
    .field--extras  { grid-area: extras; }

    @media (max-width:720px){
      .form-grid{
        grid-template-columns:1fr;
        grid-template-areas:
          "school"
          "persons"
          "from"
          "to"
          "type"
          "extras";
      }
    }

    /* === Step 2 column logic === */
    .row.cols-3{
      display:grid;
      grid-template-columns: 140px 1fr 1fr;  /* Anrede fixed, names flexible */
      gap:12px;
    }
    .row.cols-contact{
      display:grid;
      grid-template-columns: 2fr 120px 1.4fr; /* email wide, dial code narrow, phone flexible */
      gap:12px;
    }
    @media (max-width:720px){
      .row.cols-3,
      .row.cols-contact{ grid-template-columns:1fr; }
    }

    /* Extras chips layout */
    .extras{ display:flex; flex-wrap:wrap; gap:8px; }
  </style>
</head>
<body>
  <!-- Toast -->
  <div id="successMsg" class="success-msg" role="status" aria-live="polite">
    <span id="successText">Anfrage erfolgreich gesendet!</span>
  </div>

  <!-- Success overlay -->
  <div id="successOverlay" class="success-overlay" role="dialog" aria-modal="true" aria-labelledby="successTitle">
    <div class="success-card">
      <h2 id="successTitle">Anfrage gesendet</h2>
      <p id="successLead">Vielen Dank. Wir melden uns per E-Mail zur Bestätigung.</p>
      <div class="success-summary" id="successSummary"></div>
      <div class="success-actions">
        <button class="btn" id="btnBackToCalendar">Zurück zum Kalender</button>
        <button class="btn primary" id="btnNewRequest">Neue Anfrage</button>
      </div>
    </div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="start-overlay" role="dialog" aria-modal="true" aria-labelledby="startTitle">
    <div class="start-card">
      <h2 id="startTitle">Bitte wählen Sie Ihre Verkehrsschule</h2>
      <p id="startLead" class="start-hint">Einige Standorte sind ggf. noch nicht online buchbar.</p>
      <div class="start-grid"></div>
      <p class="start-hint" id="startHintBelow">Sie können den Standort später oben im Auswahlfeld wechseln.</p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="left">
      <img src="logo.webp" alt="Logo" style="display:none;" id="logoImg">
      <h1 id="titleApp">Belegung Verkehrsschulen</h1>
    </div>
    <div class="controls">
      <label for="schoolSelect" id="labelSchool">Standort</label>
      <select id="schoolSelect">
        <option value="" disabled selected id="loadingOption">Lade Standorte...</option>
      </select>

      <label for="langSelect" id="labelLang">Sprache</label>
      <select id="langSelect">
        <option value="de" selected>Deutsch</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <!-- Intro -->
  <div class="intro">
    <p id="introLine1">Wählen Sie oben Ihre Verkehrsschule. Blaue Blöcke sind bereits belegt. Tippen oder ziehen Sie im Kalender, um einen Zeitraum auszuwählen und eine Anfrage zu senden.</p>
    <p id="introHint" class="hint">Hinweis: Ihre Anfrage ist unverbindlich. Wir melden uns per E-Mail mit einer Bestätigung.</p>
  </div>

  <!-- Calendar -->
  <div id="calendarLoading" class="loading">Lade Kalender...</div>
  <div id="calendar"></div>

  <button id="mobileAdd" class="mobile-add" title="Zeitslot hinzufügen" aria-label="Zeitslot hinzufügen">+</button>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Anfrage Nutzung Verkehrsschule</h3>
      <button type="button" class="close-x" id="btnCloseX" aria-label="Schließen">×</button>

      <div class="alert warn" id="alertConflict" style="display:none;"></div>
      <div class="alert note" id="alertShort" style="display:none;"></div>

      <form id="requestForm" name="requestForm" novalidate>
        
        <!-- STEP 1 -->
        <div id="step1">
          <div class="form-grid">
            <div class="field field--school">
              <label id="labelFormSchool">Verkehrsschule *</label>
              <input id="fSchool" name="school" type="text" required readonly>
            </div>

            <div class="field field--persons">
              <label id="labelPersons">Anzahl Personen *</label>
              <input id="fPersons" name="persons" type="number" min="1" step="1" placeholder="z. B. 30" required>
              <div class="error-msg">Bitte Anzahl eingeben</div>
            </div>

            <div class="field field--from">
              <label id="labelFrom">Datum von *</label>
              <input id="fFrom" name="from" type="datetime-local" required>
            </div>

            <div class="field field--to">
              <label id="labelTo">Datum bis *</label>
              <input id="fTo" name="to" type="datetime-local" required>
            </div>

            <div class="field field--type">
              <label id="labelType">Art der Feier</label>
              <input id="fTypeFree" name="type_free" type="text" placeholder="z. B. Kindergeburtstag, Jubiläum, …">
            </div>

            <div class="field field--extras">
              <label id="labelExtras">Extras</label>
              <div class="extras" id="extrasContainer"></div>
              <div class="hint" id="extrasRunning" style="margin-top:4px">Extras: 0€</div>
            </div>
          </div>

          <!-- Prijs: compact, met toggle -->
          <div id="priceBox" class="price" aria-live="polite">
            <span class="pill"><strong id="priceTitle">Vorläufige Preisindikation:</strong> <span id="priceValue">–</span></span>
            <span id="priceToggle" class="toggle">Details</span>
          </div>
          <div id="priceHint" class="hint">(unverbindlich; endgültige Bestätigung und ggf. Anpassungen vorbehalten)</div>
          <div id="priceBreakdown" class="breakdown">
            <div class="row"><span id="bdBaseLabel" class="muted">Basis</span><span id="bdBase">–</span></div>
            <div class="row"><span id="bdPersonsLabel" class="muted">Personen-Staffel</span><span id="bdPersons">–</span></div>
            <div class="row">
              <span class="muted tooltip-wrap">
                <span id="bdTimeLabel">Zeit-Zuschlag</span>
                <span id="timeInfo" class="tooltip-icon" aria-haspopup="dialog" aria-expanded="false" tabindex="0">?</span>
                <div id="timeInfoPopover" class="popover" role="dialog" aria-hidden="true"></div>
              </span>
              <span id="bdTime">–</span>
            </div>
            <div class="row"><span id="bdExtrasLabel" class="muted">Extras</span><span id="bdExtras">–</span></div>
            <div class="row total"><span id="bdTotalLabel">Summe</span><span id="bdTotal">–</span></div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn primary" id="btnToStep2">Weiter</button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" style="display:none">
          <div class="grid">
            <!-- Persoonsgegevens: anrede | voornaam | achternaam -->
            <div class="row cols-3" style="grid-column:1/-1">
              <div class="field sm">
                <label id="labelSalutation">Anrede</label>
                <select id="fSalutation" name="salutation">
                  <option value=""></option>
                  <option value="Frau">Frau</option>
                  <option value="Herr">Herr</option>
                  <option value="Divers">Divers</option>
                  <option value="Keine Angabe">Keine Angabe</option>
                </select>
              </div>
              <div class="field">
                <label id="labelFirstName">Vorname</label>
                <input id="fFirstName" name="first_name" type="text" placeholder="z. B. Alex" autocomplete="given-name">
              </div>
              <div class="field">
                <label id="labelLastName">Nachname</label>
                <input id="fLastName" name="last_name" type="text" placeholder="z. B. Müller" autocomplete="family-name">
              </div>
            </div>

            <!-- Contact row: email | dial code | phone -->
            <div class="row cols-contact" style="grid-column:1/-1">
              <div class="field">
                <label id="labelEmail">E-Mail *</label>
                <input id="fEmail" name="email" type="email" required placeholder="name@example.org" autocomplete="email">
                <div class="error-msg">Gültige E-Mail-Adresse erforderlich</div>
              </div>
              <div class="field sm">
                <label id="labelPhoneCountry">Vorwahl</label>
                <!-- free input with suggestions; default +49 -->
                <input id="fPhoneCountry" name="phone_country" type="text" value="+49" inputmode="tel" pattern="^\+\d{1,4}$" list="dialCodes" placeholder="+49">
                <datalist id="dialCodes">
                  <option value="+49"><option value="+43"><option value="+41"><option value="+44"><option value="+33">
                  <option value="+39"><option value="+34"><option value="+32"><option value="+1"><option value="+61">
                  <option value="+31"><option value="+48"><option value="+46"><option value="+45"><option value="+420">
                  <!-- keep short; user can enter any +code -->
                </datalist>
              </div>
              <div class="field">
                <label id="labelPhone">Telefon *</label>
                <input id="fPhoneNat" name="phone_national" type="tel" inputmode="tel" placeholder="z. B. 1512345678" required autocomplete="tel-national">
                <div class="error-msg">Bitte eine gültige Nummer angeben</div>
              </div>
            </div>

            <!-- Adres (met suggesties) - SPLITS PLZ/Ort -->
            <div class="field" style="grid-column:1/-1">
              <label id="labelAddress">Anschrift *</label>
              <div class="row-compact">
                <input id="fStreet" name="street" type="text" placeholder="Straße" required autocomplete="address-line1">
                <input id="fHouse"  name="house"  type="text" placeholder="Nr." required autocomplete="on">
                <div style="display:grid;grid-template-columns:90px 1fr;gap:8px">
                  <input id="fZip"   type="text" placeholder="PLZ" required inputmode="numeric" pattern="[0-9]*" autocomplete="postal-code">
                  <input id="fCity"  type="text" placeholder="Ort" required autocomplete="address-level2">
                </div>
              </div>
              <input id="fZipCity" name="zipcity" type="hidden">
              <input id="fAddressFull" name="address" type="hidden">
              <div class="hint" id="addrHintHelp" style="margin-top:6px;display:none"></div>
            </div>

            <!-- Remove visible Eventdetails row; keep hidden fBikes to not break JS -->
            <input id="fBikes" name="bikes" type="hidden" value="">

            <!-- Bericht -->
            <div class="field" style="grid-column:1/-1">
              <label id="labelMsg">Nachricht (optional)</label>
              <textarea id="fMsg" name="message" rows="3" placeholder="Weitere Hinweise…"></textarea>
            </div>
          </div>

          <!-- Wesentliche Bedingungen -->
          <details class="summarybox">
            <summary id="termsSummary">Wesentliche Bedingungen (Kurzfassung)</summary>
            <ul id="termsList" style="margin:8px 0 0 16px;padding:0">
              <li>Nutzungsentgelt vorab per Überweisung; Reservierung erst verbindlich nach Zahlungseingang.</li>
              <li>Stornierung bis 14 Tage vor Termin: volle Erstattung; danach Einbehalt als Entschädigung.</li>
              <li>Saubere Übergabe; Müll bitte mitnehmen. Unzureichende Reinigung kann berechnet werden.</li>
              <li>Rücksicht auf Nachbarn: werktags &amp; So ab 20:00, Sa ab 22:00 Lautstärke reduzieren.</li>
              <li>Rauchverbot auf dem Gelände (nur außerhalb, Aschenbecher nutzen).</li>
              <li>Nutzung auf eigene Gefahr; empfohlen: Veranstaltungshaftpflichtversicherung.</li>
              <li>Für verursachte Schäden haften die Nutzer*innen.</li>
              <li>Kein exklusives Nutzungsrecht am gesamten Gelände; ggf. Parallelnutzungen ohne Konflikte.</li>
              <li>Mo–Sa 14:00–18:00 Kinderfreizeitprojekt: Innenraum steht Ihnen exklusiv zur Verfügung.</li>
              <li>Verspätete An-/Abmeldung kann mit 50 €/angefangene Stunde berechnet werden.</li>
            </ul>
          </details>

          <div class="modal-actions" style="justify-content:space-between">
            <button type="button" class="btn" id="btnBackStep1">Zurück</button>
          </div>
        </div>

        <!-- Sticky verzendbalk -->
        <div class="sticky-bar" id="stickyBar">
          <div class="sum" id="stickySum">
            <b id="stickyPrice">–</b> · <span id="stickyWhen">–</span> · <span id="stickyPersons">–</span>
          </div>
          <label class="checkline" style="margin-left:auto;margin-right:6px">
            <input type="checkbox" id="fAccept"> <span id="labelAccept">Ich habe die wesentlichen Bedingungen gelesen und akzeptiere sie.</span>
          </label>
          <button type="submit" class="btn primary" id="btnSubmit" disabled>Anfrage senden</button>
        </div>

        <noscript>
          <p class="hint">JavaScript ist deaktiviert. Nach dem Absenden wird das Formular neu geladen.</p>
        </noscript>
      </form>
    </div>
  </div>

  <script>
    /* ================================
       I18N
       ================================ */
    const I18N = {
      de: {
        appTitle: "Belegung Verkehrsschulen",
        labelSchool: "Standort",
        labelLang: "Sprache",
        loadingSchools: "Lade Standorte...",
        loadingCalendar: "Lade Kalender...",
        intro1: "Wählen Sie oben Ihre Verkehrsschule. Blaue Blöcke sind bereits belegt. Tippen oder ziehen Sie im Kalender, um einen Zeitraum auszuwählen und eine Anfrage zu senden.",
        introHint: "Hinweis: Ihre Anfrage ist unverbindlich. Wir melden uns per E-Mail mit einer Bestätigung.",
        modalTitle: "Anfrage Nutzung Verkehrsschule",
        formSchool: "Verkehrsschule",
        persons: "Anzahl Personen",
        from: "Datum von",
        to: "Datum bis",
        salutation: "Anrede",
        firstName: "Vorname",
        lastName: "Nachname",
        email: "E-Mail",
        phoneCountry: "Vorwahl",
        phone: "Telefon",
        address: "Anschrift",
        type: "Art der Feier",
        bikes: "Nutzung Fahrräder (kostenlos): Anzahl & Größen/Alter",
        extras: "Extras",
        extraParcours: "Fahrradparcours",
        extraGrill: "Grill",
        extraTisch: "Tischtennisplatte",
        message: "Nachricht (optional)",
        accept: "Ich habe die wesentlichen Bedingungen gelesen und akzeptiere sie.",
        conflict: "Ausgewählter Zeitraum überschneidet sich mit einer bestehenden Belegung, ist kürzer als 30 Minuten oder ungültig (Ende vor Beginn).",
        shortTermWarning: "<strong>Kurzfristige Anfrage:</strong> Da Ihr gewünschter Termin in weniger als 7 Tagen liegt, können wir nicht garantieren, dass wir Ihre Anfrage rechtzeitig bearbeiten können.",
        priceTitle: "Vorläufige Preisindikation:",
        priceHint: " (unverbindlich; endgültige Bestätigung und ggf. Anpassungen vorbehalten)",
        termsSummary: "Wesentliche Bedingungen (Kurzfassung)",
        terms: [
          "Nutzungsentgelt vorab per Überweisung; Reservierung erst verbindlich nach Zahlungseingang.",
          "Stornierung bis 14 Tage vor Termin: volle Erstattung; danach Einbehalt als Entschädigung.",
          "Saubere Übergabe; Müll bitte mitnehmen. Unzureichende Reinigung kann berechnet werden.",
          "Rücksicht auf Nachbarn: werktags & So ab 20:00, Sa ab 22:00 Lautstärke reduzieren.",
          "Rauchverbot auf dem Gelände (nur außerhalb, Aschenbecher nutzen).",
          "Nutzung auf eigene Gefahr; empfohlen: Veranstaltungshaftpflichtversicherung.",
          "Für verursachte Schäden haften die Nutzer*innen.",
          "Kein exklusives Nutzungsrecht am gesamten Gelände; ggf. Parallelnutzungen ohne Konflikte.",
          "Mo–Sa 14:00–18:00 Kinderfreizeitprojekt: Innenraum steht Ihnen exklusiv zur Verfügung.",
          "Verspätete An-/Abmeldung kann mit 50 €/angefangene Stunde berechnet werden."
        ],
        btnCancel: "Abbrechen",
        btnSend: "Anfrage senden",
        phPersons: "z. B. 30",
        phType: "z. B. Kindergeburtstag, Jubiläum, …",
        phBikes: "z. B. 6 Räder: 2×14'', 2×16'', 2×20'' / Alter 5–9",
        bdBase: (tier)=>`Basis (bis ${tier} Std.)`,
        bdPersons: (label)=>`Personen-Staffel (${label})`,
        bdTime: "Zeit-Zuschlag",
        bdExtras: "Extras",
        bdTotal: "Summe",
        bdNoExtras: "keine",
        priceOnReq: "Preis nach Vereinbarung",
        bdTimeInfo: "30 € Zuschlag, wenn Beginn UND Ende nicht zwischen 9–18 Uhr liegen oder wenn der Zeitraum (auch teilweise) am Wochenende liegt.",
        successTitle: "Anfrage gesendet",
        successLead: "Vielen Dank. Wir melden uns per E-Mail zur Bestätigung.",
        successBack: "Zurück zum Kalender",
        successNew: "Neue Anfrage",
        successSummaryLabels: { school: "Standort", from: "Von", to: "Bis", persons: "Personen", extras: "Extras" },
        startTitle: "Bitte wählen Sie Ihre Verkehrsschule",
        startLead: "Einige Standorte sind ggf. noch nicht online buchbar.",
        startHint: "Sie können den Standort später oben im Auswahlfeld wechseln.",
        onlineBookable: "Online buchbar",
        notOnline: "Derzeit nicht online buchbar",
        choose: "Auswählen"
      },
      en: {
        appTitle: "Traffic School Availability",
        labelSchool: "Location",
        labelLang: "Language",
        loadingSchools: "Loading locations...",
        loadingCalendar: "Loading calendar...",
        intro1: "Pick your location above. Blue blocks are already booked. Tap or drag in the calendar to select a time and send a request.",
        introHint: "Note: Your request is non-binding. We'll confirm by email.",
        modalTitle: "Request to Use Traffic School",
        formSchool: "Traffic school",
        persons: "Number of people",
        from: "Date/Time from",
        to: "Date/Time to",
        salutation: "Salutation",
        firstName: "First name",
        lastName: "Last name",
        email: "Email",
        phoneCountry: "Country code",
        phone: "Phone number",
        address: "Address",
        type: "Type of event",
        bikes: "Use of bikes (free): quantity & sizes/ages",
        extras: "Extras",
        extraParcours: "Bike course",
        extraGrill: "Grill",
        extraTisch: "Table tennis",
        message: "Message (optional)",
        accept: "I have read and accept the key conditions.",
        conflict: "Selected period overlaps with an existing booking, is shorter than 30 minutes, or is invalid (end before start).",
        shortTermWarning: "<strong>Short-notice request:</strong> As your requested time is in less than 7 days, we cannot guarantee timely processing.",
        priceTitle: "Preliminary price indication:",
        priceHint: " (non-binding; subject to confirmation and possible adjustments)",
        termsSummary: "Key conditions (short version)",
        terms: [
          "Pay in advance by bank transfer; booking becomes binding only after receipt of payment.",
          "Cancellation up to 14 days before: full refund; after that, fee retained as compensation.",
          "Leave the venue clean; take your rubbish with you. Extra cleaning may be charged.",
          "Be mindful of neighbours: lower noise after 20:00 (Mon–Fri & Sun) and after 22:00 (Sat).",
          "No smoking on the premises (outside only; use an ashtray).",
          "Use at your own risk; event liability insurance recommended.",
          "Users are liable for any damages caused.",
          "No exclusive right to the entire site; parallel use may occur without conflicts.",
          "Mon–Sat 14:00–18:00 kids' project: indoor room is exclusively yours.",
          "Late start/overrun may be charged at €50 per started hour."
        ],
        btnCancel: "Cancel",
        btnSend: "Send request",
        phPersons: "e.g. 30",
        phType: "e.g. kids' birthday, anniversary …",
        phBikes: "e.g. 6 bikes: 2×14'', 2×16'', 2×20'' / ages 5–9",
        bdBase: (tier)=>`Base (up to ${tier} h)`,
        bdPersons: (label)=>`People tier (${label})`,
        bdTime: "Time surcharge",
        bdExtras: "Extras",
        bdTotal: "Total",
        bdNoExtras: "none",
        priceOnReq: "Price on request",
        bdTimeInfo: "€30 surcharge if start AND end are not between 9:00–18:00, or if any part of the booking falls on a weekend.",
        successTitle: "Request submitted",
        successLead: "Thanks. We will contact you by email to confirm.",
        successBack: "Back to calendar",
        successNew: "New request",
        successSummaryLabels: { school: "Location", from: "From", to: "To", persons: "People", extras: "Extras" },
        startTitle: "Please choose your traffic school",
        startLead: "Some locations may not yet be available for online booking.",
        startHint: "You can change the location later from the selector above.",
        onlineBookable: "Bookable online",
        notOnline: "Currently not online bookable",
        choose: "Choose"
      }
    };

    /* ===== Locations ===== */
    const SCHOOLS = {
      WA: { name: "Verkehrsschule am Wassertorplatz", short:"Wassertorplatz", file: "events-wa.json", address: "Wassertorplatz 1, 10999 Berlin" },
      WI: { name: "Verkehrsschule Wiener Straße",     short:"Wiener Straße",  file: "events-wi.json", address: "Wiener Str. 59c, 10999 Berlin" },
      WE: { name: "Verkehrsschule Weinstraße",        short:"Weinstraße",     file: "events-we.json", address: "Weinstraße 2, 10249 Berlin" }
    };

    /* === Per-school pricing & extras config === */
    const PRICING = {
      WE: {                                   // Weinstraße (keep current)
        tiers: [                              // same as TIERS_MINUTES you had
          { maxMin: 240, hoursLabel: 4,  base: 100 },
          { maxMin: 360, hoursLabel: 6,  base: 130 },
          { maxMin: 480, hoursLabel: 8,  base: 160 },
          { maxMin: 600, hoursLabel:10,  base: 190 },
          { maxMin: 720, hoursLabel:12,  base: 220 },
          { maxMin: 960, hoursLabel:16,  base: 280 },
          { maxMin:1440, hoursLabel:24,  base: 360 },
        ],
        personTiers: [                        // same multipliers you had
          { max: 30, mult: 1.00, label: "≤30" },
          { max: 40, mult: 1.25, label: "≤40" },
          { max: 50, mult: 1.50, label: "≤50" },
          { max: 75, mult: 1.75, label: "≤75" },
          { max:100, mult: 2.00, label: "≤100" },
        ],
        surcharge: defaultSurcharge30,        // same 30€ rule as now
        extras: [                             // keep current extras for WE
          { id: "parcours",  price: 10, labelDe: "Fahrradparcours",  labelEn: "Bike course" },
          { id: "grill",     price: 10, labelDe: "Grill",            labelEn: "Grill" },
          { id: "tisch",     price: 10, labelDe: "Tischtennisplatte",labelEn: "Table tennis" },
        ]
      },

      WI: {                                   // Wiener Straße (no extras for now)
        tiers: [                              // same as WE
          { maxMin: 240, hoursLabel: 4,  base: 100 },
          { maxMin: 360, hoursLabel: 6,  base: 130 },
          { maxMin: 480, hoursLabel: 8,  base: 160 },
          { maxMin: 600, hoursLabel:10,  base: 190 },
          { maxMin: 720, hoursLabel:12,  base: 220 },
          { maxMin: 960, hoursLabel:16,  base: 280 },
          { maxMin:1440, hoursLabel:24,  base: 360 },
        ],
        personTiers: [                        // same as WE
          { max: 30, mult: 1.00, label: "≤30" },
          { max: 40, mult: 1.25, label: "≤40" },
          { max: 50, mult: 1.50, label: "≤50" },
          { max: 75, mult: 1.75, label: "≤75" },
          { max:100, mult: 2.00, label: "≤100" },
        ],
        surcharge: defaultSurcharge30,
        extras: []                            // none (can add later)
      },

      WA: {                                   // Wassertorplatz (DIFFERENT scheme)
        tiers: [                              // higher base prices
          { maxMin: 240, hoursLabel: 4,  base: 120 },
          { maxMin: 360, hoursLabel: 6,  base: 155 },
          { maxMin: 480, hoursLabel: 8,  base: 185 },
          { maxMin: 600, hoursLabel:10,  base: 220 },
          { maxMin: 720, hoursLabel:12,  base: 255 },
          { maxMin: 960, hoursLabel:16,  base: 320 },
          { maxMin:1440, hoursLabel:24,  base: 400 },
        ],
        personTiers: [
          { max: 30, mult: 1.00, label: "≤30" },
          { max: 40, mult: 1.20, label: "≤40" },       // different multipliers
          { max: 50, mult: 1.45, label: "≤50" },
          { max: 75, mult: 1.70, label: "≤75" },
          { max:100, mult: 1.95, label: "≤100" },
        ],
        surcharge: defaultSurcharge30,        // same rule
        extras: []                            // none (can add later)
      },
    };

    /* Same 30 € rule you already use */
    function defaultSurcharge30(start, end){
      const between9_18 = (dt)=> {
        const m = dt.getHours()*60 + dt.getMinutes();
        return (m >= 9*60) && (m <= 18*60);
      };
      const bothOutside = !(between9_18(start) && between9_18(end));

      function touchesWeekend(s,e){
        const cur = new Date(s); cur.setHours(0,0,0,0);
        const endDay = new Date(e); endDay.setHours(23,59,59,999);
        while(cur <= endDay){ const d=cur.getDay(); if(d===0||d===6) return true; cur.setDate(cur.getDate()+1); }
        return false;
      }
      return (bothOutside || touchesWeekend(start,end)) ? 30 : 0;
    }

    function isTouchDevice(){
      return window.matchMedia('(pointer: coarse)').matches || navigator.maxTouchPoints > 0;
    }

    function renderExtrasForSchool(key){
      const container = document.getElementById('extrasContainer');
      container.innerHTML = '';
      const cfg = PRICING[key] || PRICING.WE;
      (cfg.extras || []).forEach(ex => {
        const id = `x_${ex.id}`;
        const label = (langSelect.value==='en' ? ex.labelEn : ex.labelDe) || ex.id;
        const wrap = document.createElement('label');
        wrap.className = 'badge';
        wrap.innerHTML = `
          <input type="checkbox" id="${id}" name="extras[]" data-price="${ex.price}" data-label-de="${ex.labelDe||''}" data-label-en="${ex.labelEn||''}">
          <span>${label}</span><span class="price">+${euro(ex.price).replace(/\s/g,'')}</span>
        `;
        container.appendChild(wrap);
      });

      // Re-bind change listeners to recalc price
      container.querySelectorAll('input[type="checkbox"]').forEach(el=>{
        el.addEventListener('change', ()=>{ updatePricePreview(); });
      });

      // Show/hide the whole field if there are no extras
      document.querySelector('.field--extras').style.display = (cfg.extras && cfg.extras.length) ? '' : 'none';
    }

    /* ===== DOM refs ===== */
    const schoolSelect = document.getElementById('schoolSelect');
    const langSelect   = document.getElementById('langSelect');
    const calendarEl   = document.getElementById('calendar');
    const calendarLoading = document.getElementById('calendarLoading');
    const logoImg      = document.getElementById('logoImg');

    const titleApp  = document.getElementById('titleApp');
    const labelSchool = document.getElementById('labelSchool');
    const labelLang = document.getElementById('labelLang');
    const introLine1 = document.getElementById('introLine1');
    const introHint  = document.getElementById('introHint');

    const startOverlay = document.getElementById('startOverlay');
    const startTitle = document.getElementById('startTitle');
    const startLead = document.getElementById('startLead');
    const startHintBelow = document.getElementById('startHintBelow');
    const startGrid = startOverlay.querySelector('.start-grid');

    const modalBack    = document.getElementById('modalBackdrop');
    const modalTitle   = document.getElementById('modalTitle');
    const form         = document.getElementById('requestForm');

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const btnToStep2 = document.getElementById('btnToStep2');
    const btnBackStep1 = document.getElementById('btnBackStep1');
    const btnCloseX = document.getElementById('btnCloseX');

    const alertConflict = document.getElementById('alertConflict');
    const alertShort = document.getElementById('alertShort');

    const fSchool = document.getElementById('fSchool');
    const fFrom   = document.getElementById('fFrom');
    const fTo     = document.getElementById('fTo');
    const fPersons = document.getElementById('fPersons');

    const fSalutation = document.getElementById('fSalutation');
    const fFirstName  = document.getElementById('fFirstName');
    const fLastName   = document.getElementById('fLastName');

    const fEmail    = document.getElementById('fEmail');
    const fPhoneCountry = document.getElementById('fPhoneCountry');
    const fPhoneNat = document.getElementById('fPhoneNat');

    const fStreet = document.getElementById('fStreet');
    const fHouse  = document.getElementById('fHouse');
    const fZip = document.getElementById('fZip');
    const fCity = document.getElementById('fCity');
    const fZipCity= document.getElementById('fZipCity');
    const fAddressFull = document.getElementById('fAddressFull');

    const fTypeFree = document.getElementById('fTypeFree');
    const fBikes    = document.getElementById('fBikes');
    const fMsg      = document.getElementById('fMsg');

    const labelFormSchool = document.getElementById('labelFormSchool');
    const labelPersons = document.getElementById('labelPersons');
    const labelFrom = document.getElementById('labelFrom');
    const labelTo = document.getElementById('labelTo');
    const labelType = document.getElementById('labelType');
    const labelBikes = document.getElementById('labelBikes');
    const labelEmail = document.getElementById('labelEmail');
    const labelPhone = document.getElementById('labelPhone');
    const labelPhoneCountry = document.getElementById('labelPhoneCountry');
    const labelAddress = document.getElementById('labelAddress');
    const labelSalutation = document.getElementById('labelSalutation');
    const labelFirstName = document.getElementById('labelFirstName');
    const labelLastName = document.getElementById('labelLastName');
    const labelMsg = document.getElementById('labelMsg');
    const labelAccept = document.getElementById('labelAccept');
    const fAccept = document.getElementById('fAccept');

    const stickyBar = document.getElementById('stickyBar');
    const stickyPrice = document.getElementById('stickyPrice');
    const stickyWhen = document.getElementById('stickyWhen');
    const stickyPersons = document.getElementById('stickyPersons');

    const priceTitle  = document.getElementById('priceTitle');
    const priceHint   = document.getElementById('priceHint');
    const priceValue  = document.getElementById('priceValue');
    const priceToggle = document.getElementById('priceToggle');
    const priceBreakdown = document.getElementById('priceBreakdown');
    const bdBaseLabel = document.getElementById('bdBaseLabel');
    const bdBase      = document.getElementById('bdBase');
    const bdPersonsLabel = document.getElementById('bdPersonsLabel');
    const bdPersons   = document.getElementById('bdPersons');
    const bdTimeLabel = document.getElementById('bdTimeLabel');
    const bdTime      = document.getElementById('bdTime');
    const bdExtrasLabel = document.getElementById('bdExtrasLabel');
    const bdExtras    = document.getElementById('bdExtras');
    const bdTotalLabel= document.getElementById('bdTotalLabel');
    const bdTotal     = document.getElementById('bdTotal');
    const extrasRunning = document.getElementById('extrasRunning');

    const btnSubmit   = document.getElementById('btnSubmit');

    const timeInfoIcon = document.getElementById('timeInfo');
    const timePopover  = document.getElementById('timeInfoPopover');

    const successMsg  = document.getElementById('successMsg');
    const successText = document.getElementById('successText');
    const successOverlay = document.getElementById('successOverlay');
    const successTitle = document.getElementById('successTitle');
    const successLead  = document.getElementById('successLead');
    const successSummary = document.getElementById('successSummary');
    const btnBackToCalendar = document.getElementById('btnBackToCalendar');
    const btnNewRequest = document.getElementById('btnNewRequest');
    const mobileAdd = document.getElementById('mobileAdd');

    const addrHintHelp = document.getElementById('addrHintHelp');

    const DEFAULT_TAP_MINUTES = 120;
    const MAX_EVENT_HOURS   = 24;
    const FALLBACK_MINUTES  = 120;

    let calendar = null;
    let currentKey = null;
    let busyEvents = [];
    let wasSubmitted = false;
    const availability = {};
    let CURRENT_PRICE = null;
    let untrap = null;

    /* ===== I18N apply ===== */
    function applyI18n(){
      const L = I18N[langSelect.value] || I18N.de;
      titleApp.textContent = L.appTitle;
      labelSchool.textContent = L.labelSchool;
      labelLang.textContent = L.labelLang;
      introLine1.textContent = L.intro1;
      introHint.textContent  = L.introHint;
      document.getElementById('calendarLoading').firstChild.nodeValue = L.loadingCalendar;

      modalTitle.textContent = L.modalTitle;
      labelFormSchool.textContent = L.formSchool;
      labelPersons.textContent = L.persons;
      labelFrom.textContent = (langSelect.value==='en'?'Date/Time from *':'Datum von *');
      labelTo.textContent   = (langSelect.value==='en'?'Date/Time to *':'Datum bis *');
      labelType.textContent = L.type;
      labelBikes.textContent = L.bikes;
      labelEmail.textContent = L.email;
      labelPhone.textContent = (langSelect.value==='en'?'Phone number *':'Telefon *');
      labelPhoneCountry.textContent = L.phoneCountry;
      labelAddress.textContent = L.address;
      labelSalutation.textContent = L.salutation;
      labelFirstName.textContent = L.firstName;
      labelLastName.textContent = L.lastName;
      labelMsg.textContent = L.message;
      labelAccept.textContent = L.accept;

      priceTitle.textContent = L.priceTitle;
      priceHint.textContent = L.priceHint;
      document.getElementById('termsSummary').textContent = L.termsSummary;

      const termsList = document.getElementById('termsList');
      termsList.innerHTML = "";
      L.terms.forEach(t => { const li = document.createElement('li'); li.textContent = t; termsList.appendChild(li); });

      document.getElementById('bdTimeLabel').textContent = L.bdTime;
      document.getElementById('bdExtrasLabel').textContent = L.bdExtras;
      document.getElementById('bdTotalLabel').textContent = L.bdTotal;

      btnSubmit.textContent = L.btnSend;

      fPersons.placeholder = L.phPersons;
      fTypeFree.placeholder = L.phType;
      fBikes.placeholder = L.phBikes;

      successTitle.textContent = L.successTitle;
      successLead.textContent  = L.successLead;
      btnBackToCalendar.textContent = L.successBack;
      btnNewRequest.textContent     = L.successNew;

      startTitle.textContent = L.startTitle;
      startLead.textContent = L.startLead;
      startHintBelow.textContent = L.startHint;

      if(calendar) calendar.setOption('locale', langSelect.value === 'en' ? 'en-gb' : 'de');

      renderExtrasForSchool(currentKey || 'WE');
      updatePricePreview();
      timePopover.textContent = L.bdTimeInfo;
      renderStartCards();
      renderSchoolSelectOptions();
    }SchoolSelectOptions();
    }

    /* ===== Fetch helpers ===== */
    async function fetchJson(url){
      const r = await fetch(url+'?v='+Date.now(), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const txt = await r.text();
      return JSON.parse(txt.replace(/^\uFEFF/, ''));
    }

    /* ===== Events normalize ===== */
    function normalizeEvents(raw){
      if(!Array.isArray(raw)) return [];
      const MS_PER_MIN = 60000, MS_PER_HOUR = 3600000, MS_24H = 24*MS_PER_HOUR;
      const isValidDate = (d)=> d instanceof Date && !isNaN(d.getTime());

      return raw.map(ev=>{
        const s = new Date(ev.start);
        let e = ev.end ? new Date(ev.end) : null;

        if(!isValidDate(s)) return { __drop:true };
        if(!isValidDate(e)) e = new Date(s.getTime() + FALLBACK_MINUTES*MS_PER_MIN);
        if(e <= s){
          e = new Date(e.getTime() + MS_24H);
          if(e <= s) e = new Date(s.getTime() + Math.max(30, FALLBACK_MINUTES)*MS_PER_MIN);
        }
        if((e - s) > MS_24H) e = new Date(s.getTime() + MS_24H);

        return {
          ...ev, start: s, end: e, title: ev.title || 'Belegt',
          classNames: Array.isArray(ev.classNames) ? [...ev.classNames, 'busy'] : ['busy']
        };
      }).filter(ev => !ev.__drop && ev.start instanceof Date && !isNaN(ev.start) && ev.end instanceof Date && !isNaN(ev.end));
    }

    /* ===== Discover schools ===== */
    async function discoverSchools(){
      const keys = Object.keys(SCHOOLS);
      for(const key of keys){
        try{ const data = await fetchJson(SCHOOLS[key].file); availability[key]={ok:Array.isArray(data)}; }
        catch(_e){ availability[key]={ok:false}; }
      }
      renderSchoolSelectOptions();
      renderStartCards();
      startOverlay.style.display = 'flex';
    }

    function renderSchoolSelectOptions(){
      const L = I18N[langSelect.value] || I18N.de;
      schoolSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = ''; placeholder.disabled = true; placeholder.selected = !currentKey;
      placeholder.textContent = L.loadingSchools.replace('Lade', langSelect.value==='en'?'Select':'Wählen');
      schoolSelect.appendChild(placeholder);

      for(const key of Object.keys(SCHOOLS)){
        const opt = document.createElement('option');
        opt.value = key;
        const ok = availability[key]?.ok;
        const name = SCHOOLS[key].name;
        opt.textContent = ok ? `${name}` : `${name} — ${L.notOnline}`;
        opt.className = ok ? '' : 'disabled';
        opt.disabled = !ok;
        schoolSelect.appendChild(opt);
      }
      if(currentKey) schoolSelect.value = currentKey;
    }

    function renderStartCards(){
      const L = I18N[langSelect.value] || I18N.de;
      startGrid.innerHTML = '';
      for(const key of Object.keys(SCHOOLS)){
        const { name, address } = SCHOOLS[key];
        const ok = availability[key]?.ok;
        const card = document.createElement('div');
        card.className = 'school-card' + (ok ? '' : ' disabled');
        card.innerHTML = `
          <h3 style="margin:0;font-size:16px;">${name}</h3>
          <p style="margin:0;color:#374151;font-size:13px;">${address}</p>
          <span class="status">${ ok ? L.onlineBookable : L.notOnline }</span>
          <div class="choose" style="margin-top:auto">
            <button class="btn ${ok ? 'primary' : ''}" ${ ok ? '' : 'disabled' }>${L.choose}</button>
          </div>`;
        const btn = card.querySelector('button');
        btn.addEventListener('click', ()=>{
          if(!ok) return;
          currentKey = key;
          startOverlay.style.display = 'none';
          renderSchoolSelectOptions();
          schoolSelect.value = key;
          loadCalendar(key);
        });
        startGrid.appendChild(card);
      }
    }

    /* ===== Rules / validation ===== */
    function minStartDate(){ const d=new Date(); d.setDate(d.getDate()+7); d.setHours(0,0,0,0); return d; }
    function overlaps(aStart,aEnd,bStart,bEnd){ return (aStart < bEnd) && (aEnd > bStart); }

    function formatAddress(){
      const street=(fStreet.value||'').trim();
      const house=(fHouse.value||'').trim();
      const zip=(fZip.value||'').trim();
      const city=(fCity.value||'').trim();
      const full = [street, house].filter(Boolean).join(' ') + ((zip||city)?(', '+[zip,city].filter(Boolean).join(' ')):'');
      fAddressFull.value = full.trim();
      fZipCity.value = [zip, city].filter(Boolean).join(' ').trim();
      return fAddressFull.value;
    }

    function highlight(el, on){
      const shouldShow = on && (wasSubmitted || el.dataset.touched === '1');
      el.classList.toggle('error', !!shouldShow);
      const msg = el.parentElement.querySelector('.error-msg');
      if (msg) msg.style.display = shouldShow ? 'block' : 'none';
    }

    function validateTimes(){
      const start = parseLocalDT(fFrom.value);
      const end   = parseLocalDT(fTo.value);

      let ok = true;
      if(!(start && end)) ok = false;
      if(ok && end <= start) ok = false;
      if(ok && (end - start) < 30*60000) ok = false;

      if(ok){
        for(const ev of busyEvents){
          const bS = new Date(ev.start), bE = new Date(ev.end || ev.start);
          if(overlaps(start, end, bS, bE)){ ok = false; break; }
        }
      }
      
      const showConflict = !ok && (wasSubmitted || (fFrom.dataset.touched==='1' && fTo.dataset.touched==='1'));
      alertConflict.style.display = showConflict ? 'block':'none';
      alertConflict.textContent = (I18N[langSelect.value]||I18N.de).conflict;

      if(start && start < minStartDate()) { alertShort.style.display='block'; alertShort.innerHTML = (I18N[langSelect.value]||I18N.de).shortTermWarning; }
      else { alertShort.style.display='none'; }

      const phoneOk = (fPhoneNat.value||'').replace(/[^\d]/g,'').length >= 6;
      const addrOk  = !!formatAddress();

      highlight(fPersons, !fPersons.value);
      highlight(fEmail, !fEmail.validity.valid);
      highlight(fPhoneNat, !phoneOk);
      highlight(fStreet, !(fStreet.value||'').trim());
      highlight(fHouse,  !(fHouse.value||'').trim());
      highlight(fZip,    !(fZip.value||'').trim());
      highlight(fCity,   !(fCity.value||'').trim());

      const requireAccept = (step2.style.display !== 'none');
      const requiredOk = fSchool.value && fPersons.value && start && end && phoneOk && addrOk && fEmail.validity.valid && (!requireAccept || fAccept.checked);
      btnSubmit.disabled = !(ok && requiredOk);
      updatePricePreview(); 
      updateSticky();
      return ok && requiredOk;
    }

    function selectAllowFn(selectInfo){
      const selStart = selectInfo.start, selEnd = selectInfo.end;
      for(const ev of busyEvents){
        const bS = new Date(ev.start), bE = new Date(ev.end || ev.start);
        if(overlaps(selStart, selEnd, bS, bE)) return false;
      }
      if((selEnd - selStart)/60000 < 30) return false;
      return true;
    }

    function desiredView(){ const w = calendarEl.clientWidth || window.innerWidth; return (w < 700) ? 'timeGridDay' : 'timeGridWeek'; }
    function applyResponsiveView(){ if(!calendar) return; const want = desiredView(); if(calendar.view && calendar.view.type !== want) calendar.changeView(want); }

    /* ===== Wizard & sticky bar ===== */
    function goStep(n){
      if(n===1){ step1.style.display='block'; step2.style.display='none'; }
      else { step1.style.display='none'; step2.style.display='block'; }

      // show/hide final controls
      const agreeWrap = document.getElementById('fAccept').closest('.checkline');
      if(agreeWrap){ agreeWrap.style.display = (n===2 ? 'inline-flex' : 'none'); }
      btnSubmit.style.display = (n===2 ? 'inline-flex' : 'none');

      sendHeightThrottled();
    }

    function updateSticky(){
      stickyPrice.textContent = priceValue.textContent || '–';
      const s = parseLocalDT(fFrom.value), e = parseLocalDT(fTo.value);
      stickyWhen.textContent = (s&&e)? `${formatDT(s, langSelect.value)} – ${formatDT(e, langSelect.value)}` : '–';
      stickyPersons.textContent = fPersons.value ? `${fPersons.value} Pers.` : '';
    }

    btnToStep2.addEventListener('click', ()=>{ 
      // Valideer alleen stap 1 velden
      const start = parseLocalDT(fFrom.value);
      const end   = parseLocalDT(fTo.value);
      
      let ok = true;
      if(!(start && end)) ok = false;
      if(ok && end <= start) ok = false;
      if(ok && (end - start) < 30*60000) ok = false;
      
      if(ok){
        for(const ev of busyEvents){
          const bS = new Date(ev.start), bE = new Date(ev.end || ev.start);
          if(overlaps(start, end, bS, bE)){ ok = false; break; }
        }
      }
      
      const showConflict = !ok && (fFrom.dataset.touched==='1' && fTo.dataset.touched==='1');
      alertConflict.style.display = showConflict ? 'block':'none';
      alertConflict.textContent = (I18N[langSelect.value]||I18N.de).conflict;
      
      if(start && start < minStartDate()) { 
        alertShort.style.display='block'; 
        alertShort.innerHTML = (I18N[langSelect.value]||I18N.de).shortTermWarning; 
      } else { 
        alertShort.style.display='none'; 
      }
      
      // Check alleen personen voor stap 1
      highlight(fPersons, !fPersons.value);
      
      if(ok && fPersons.value) {
        goStep(2);
      } else {
        // Zet touched op true zodat errors zichtbaar worden
        fFrom.dataset.touched = '1';
        fTo.dataset.touched = '1';
        fPersons.dataset.touched = '1';
        validateTimes();
      }
    });
    btnBackStep1.addEventListener('click', ()=> goStep(1));
    btnCloseX.addEventListener('click', closeModal);

    priceToggle.addEventListener('click', ()=>{
      priceBreakdown.style.display = priceBreakdown.style.display==='none' ? 'block':'none';
      sendHeightThrottled();
    });

    /* ===== Focus trap ===== */
    function trapFocus(container){
      const FOCUS = 'a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])';
      const nodes=()=>Array.from(container.querySelectorAll(FOCUS)).filter(el=>!el.disabled && el.offsetParent!==null);
      function onKey(e){
        if(e.key!=='Tab') return;
        const a = nodes(); if(!a.length) return;
        const first=a[0], last=a[a.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      container.addEventListener('keydown', onKey);
      return ()=>container.removeEventListener('keydown', onKey);
    }

    function openModal(prefill){
      fSchool.value = prefill.school;
      fFrom.value = toInputLocal(prefill.start);
      fTo.value   = toInputLocal(prefill.end);
      alertConflict.style.display = 'none';
      alertShort.style.display = 'none';
      fAccept.checked = false;
      btnSubmit.disabled = true;
      formatAddress();
      renderExtrasForSchool(currentKey || 'WE');
      updatePricePreview();
      goStep(1);
      modalBack.style.display = 'flex';
      validateTimes();
      if(untrap) untrap(); 
      untrap = trapFocus(modalBack);
    }

    function closeModal(){
      modalBack.style.display = 'none';
      form.reset();
      fSchool.value = '';
      alertConflict.style.display = 'none';
      alertShort.style.display = 'none';
      btnSubmit.disabled = true;
      priceValue.textContent = '–';
      priceBreakdown.style.display = 'none';
      hidePopover();
      if(untrap) untrap();
    }

    /* ===== Utils ===== */
    function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    async function nominatim(q){
      if(!q || q.length < 3) return [];
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&countrycodes=de&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!res.ok) return [];
      return res.json();
    }

    const updateStreetHints = debounce(async ()=>{
      const base=(fStreet.value||'').trim();
      const city=(fCity.value||'').trim();
      const q = (base+' '+city).trim();
      if(q.replace(/\s+/g,' ').length < 3) return;
      
      const data = await nominatim(q);
      const hints = new Set();
      data.forEach(r=>{
        const a = r.address||{};
        const street = a.road || a.pedestrian || a.footway || a.path || '';
        if(street) hints.add(street);
      });
      addrHintHelp.style.display = hints.size ? 'block' : 'none';
      addrHintHelp.textContent = hints.size ? 'Tipp: Vorschläge nutzen' : '';
    }, 450);

    const updateCityHints = debounce(async ()=>{
      const q=(fCity.value||'').trim();
      if(q.length<3) return;
      
      const data = await nominatim(q);
      const hints = new Set();
      data.forEach(r=>{
        const a = r.address||{};
        const plz  = a.postcode || '';
        const city = a.city || a.town || a.village || a.suburb || '';
        if(plz && city) hints.add(`${plz} ${city}`);
      });
    }, 450);

    fStreet.addEventListener('input', updateStreetHints);
    fCity.addEventListener('input', updateCityHints);

    [fZip,fCity].forEach(el=>{ 
      el.addEventListener('input', ()=>{ formatAddress(); validateTimes(); }); 
      el.addEventListener('blur', ()=>{ el.dataset.touched='1'; validateTimes(); }); 
    });

    [fFrom,fTo,fPersons,fEmail,fPhoneNat,fAccept].forEach(el=>{
      el.addEventListener('change', validateTimes);
      el.addEventListener('input', validateTimes);
    });

    [fFrom,fTo,fPersons,fEmail,fPhoneNat,fStreet,fHouse,fZip,fCity].forEach(el=>{
      el.addEventListener('blur', ()=>{ el.dataset.touched = '1'; validateTimes(); });
    });

    fPhoneNat.addEventListener('input', ()=>{
      const cur = fPhoneNat.selectionStart;
      fPhoneNat.value = (fPhoneNat.value || '').replace(/[^\d]/g,'');
      fPhoneNat.setSelectionRange(cur, cur);
    });

    function formatDT(dt, lang){
      const d = (dt instanceof Date) ? dt : new Date(dt);
      return d.toLocaleString(lang === 'en' ? 'en-GB' : 'de-DE', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    }

    function toInputLocal(date){
      const d = (date instanceof Date) ? date : new Date(date);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function parseLocalDT(v){
      if(!v) return null;
      const [date, time] = v.split('T'); if(!date || !time) return null;
      const [y,m,d] = date.split('-').map(Number);
      const [hh,mm] = time.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }

    function euro(n){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR', maximumFractionDigits:2}).format(n); }

    /* ===== Calendar loading ===== */
    schoolSelect.addEventListener('change', (e)=> {
      const key = e.target.value;
      if(!availability[key]?.ok) return;
      currentKey = key;
      loadCalendar(key);
    });

    langSelect.addEventListener('change', applyI18n);

    mobileAdd.addEventListener('click', ()=>{
      const start = new Date(); start.setDate(start.getDate()+7); start.setHours(10,0,0,0);
      const end = new Date(start.getTime() + DEFAULT_TAP_MINUTES*60000);
      openModal({ school: SCHOOLS[currentKey]?.name || '', start, end });
    });

    async function loadCalendar(key){
      if(!availability[key]?.ok) return;
      currentKey = key;
      calendarLoading.style.display = 'block';
      if(calendar) calendar.destroy();

      const raw = await fetchJson(SCHOOLS[key].file);
      busyEvents = normalizeEvents(raw);

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: (calendarEl.clientWidth || window.innerWidth) < 700 ? 'timeGridDay' : 'timeGridWeek',
        firstDay: 1,
        locale: langSelect.value === 'en' ? 'en-gb' : 'de',
        timeZone: 'local',
        slotMinTime: '12:00:00',
        slotMaxTime: '22:00:00',
        height: 'auto',
        expandRows: true,
        allDaySlot: false,
        nowIndicator: false,
        selectMirror: true,
        longPressDelay: 120,
        unselectAuto: true,
        selectOverlap: true,
        
        selectable: !isTouchDevice(),
        selectMinDistance: 8,
        longPressDelay: 300,
        selectLongPressDelay: 300,

        selectAllow: selectAllowFn,
        events: busyEvents,
        windowResize: () => applyResponsiveView(),
        select: (info)=>{
          openModal({ school: SCHOOLS[currentKey].name, start: info.start, end: info.end });
          calendar.unselect();
        },
        dateClick: (arg)=>{
          if(arg.allDay) return;
          const start = arg.date;
          const end = new Date(start.getTime() + DEFAULT_TAP_MINUTES*60000);
          openModal({ school: SCHOOLS[currentKey].name, start, end });
        }
      });

      calendar.render();
      mobileAdd.style.display = isTouchDevice() ? 'block' : 'none';
      applyResponsiveView();
      calendarLoading.style.display = 'none';
      calendarEl.classList.add('loaded');
      fSchool.value = SCHOOLS[currentKey].name;
      renderExtrasForSchool(key);
      updatePricePreview();
    }

    /* ===== Price calculation ===== */
    function updatePricePreview(){
      const L = I18N[langSelect.value] || I18N.de;
      const start = parseLocalDT(fFrom.value);
      const end   = parseLocalDT(fTo.value);
      const persons = Number(fPersons.value || 0);
      CURRENT_PRICE = null;

      if(!(start && end) || end <= start){
        priceValue.textContent = '–';
        priceBreakdown.style.display = 'none';
        hidePopover();
        updateSticky();
        return;
      }

      const cfg = PRICING[currentKey] || PRICING.WE;

      // tier by minutes
      const totalMin = Math.round((end - start) / 60000);
      const tier = (cfg.tiers || []).find(t => totalMin <= t.maxMin) || null;

      // person multiplier
      let mult = null, pplLabel = ">100";
      for (const pt of (cfg.personTiers || [])){
        if (persons <= pt.max){ mult = pt.mult; pplLabel = pt.label; break; }
      }

      if(!tier || mult === null){
        priceValue.textContent = L.priceOnReq;
        priceBreakdown.style.display = 'none';
        hidePopover();
        updateSticky();
        return;
      }

      const base = tier.base;
      const basePlusPersons = base * mult;
      const personsDelta = basePlusPersons - base;
      const timeAdd = typeof cfg.surcharge === 'function' ? cfg.surcharge(start, end) : 0;

      // extras (dynamic)
      const checked = Array.from(document.querySelectorAll('#extrasContainer input:checked'));
      const extrasCost = checked.reduce((sum, el)=> sum + Number(el.dataset.price||0), 0);
      const extrasSelected = checked.map(el => (langSelect.value==='en' ? el.dataset.labelEn : el.dataset.labelDe) || '');

      const total = basePlusPersons + timeAdd + extrasCost;

      // UI
      priceValue.textContent = euro(total);
      bdBaseLabel.textContent = (langSelect.value==='en' ? I18N.en.bdBase(tier.hoursLabel) : I18N.de.bdBase(tier.hoursLabel));
      bdBase.textContent = euro(base);
      bdPersonsLabel.textContent = (langSelect.value==='en' ? I18N.en.bdPersons(pplLabel) : I18N.de.bdPersons(pplLabel));
      bdPersons.textContent = personsDelta === 0 ? (langSelect.value==='en' ? "€0.00" : "0,00 €") : euro(personsDelta);
      bdTimeLabel.textContent = L.bdTime;
      bdTime.textContent = timeAdd ? euro(timeAdd) : (langSelect.value==='en' ? "€0.00" : "0,00 €");
      bdExtrasLabel.textContent = L.bdExtras;
      bdExtras.textContent = extrasCost ? euro(extrasCost) : (L.bdNoExtras || (langSelect.value==='en' ? "none" : "keine"));
      bdTotalLabel.textContent = L.bdTotal;
      bdTotal.textContent = euro(total);
      timePopover.textContent = L.bdTimeInfo;

      CURRENT_PRICE = {
        currency: 'EUR',
        tierHours: tier.hoursLabel,
        personsMultiplier: mult,
        personsLabel: pplLabel,
        base: Number(base),
        personsDelta: Number(personsDelta),
        timeSurcharge: Number(timeAdd),
        extrasCount: checked.length,
        extrasCost: Number(extrasCost),
        total: Number(total),
        extrasSelected
      };

      priceBreakdown.style.display = 'block';
      updateSticky();

      // Small running hint (optional)
      const extrasRunning = document.getElementById('extrasRunning');
      if (extrasRunning) extrasRunning.textContent = `Extras: ${euro(extrasCost)}`;
    }

    /* ===== Popover help ===== */
    function togglePopover(){ const isOpen = timePopover.classList.contains('show'); if(isOpen){ hidePopover(); return; } showPopover(); }
    function showPopover(){
      timePopover.classList.add('show'); timePopover.setAttribute('aria-hidden','false'); timeInfoIcon.setAttribute('aria-expanded','true');
      const rect = timePopover.getBoundingClientRect();
      if(rect.right > window.innerWidth - 12){ timePopover.style.left = 'auto'; timePopover.style.right = '0'; }
      else { timePopover.style.left = '0'; timePopover.style.right = 'auto'; }
    }
    function hidePopover(){
      timePopover.classList.remove('show'); timePopover.setAttribute('aria-hidden','true'); timeInfoIcon.setAttribute('aria-expanded','false');
    }
    document.addEventListener('click', (e)=>{ if(!timePopover.classList.contains('show')) return; const within = e.target.closest('.tooltip-wrap'); if(!within) hidePopover(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hidePopover(); if((e.key === 'Enter' || e.key === ' ') && document.activeElement === timeInfoIcon){ e.preventDefault(); togglePopover(); } });
    timeInfoIcon.addEventListener('click', (e)=>{ e.stopPropagation(); togglePopover(); });
    timeInfoIcon.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); togglePopover(); } });

    /* ===== Success overlay ===== */
    function showSuccessOverlay(payload){
      const L = I18N[langSelect.value] || I18N.de;
      successTitle.textContent = L.successTitle;
      successLead.textContent  = L.successLead;
      btnBackToCalendar.textContent = L.successBack;
      btnNewRequest.textContent     = L.successNew;

      const labels = L.successSummaryLabels;
      const extrasText = (CURRENT_PRICE && CURRENT_PRICE.extrasSelected && CURRENT_PRICE.extrasSelected.length)
        ? CURRENT_PRICE.extrasSelected
        : [];

      const start = parseLocalDT(payload.from);
      const end   = parseLocalDT(payload.to);

      successSummary.innerHTML = `
        <div><strong>${labels.school}:</strong> ${payload.school || ""}</div>
        <div><strong>${labels.from}:</strong> ${formatDT(start, langSelect.value)}</div>
        <div><strong>${labels.to}:</strong> ${formatDT(end,   langSelect.value)}</div>
        ${payload.persons ? `<div><strong>${labels.persons}:</strong> ${payload.persons}</div>` : ""}
        <div><strong>${labels.extras}:</strong> ${extrasText.length ? extrasText.join(", ") : ((I18N[langSelect.value]||I18N.de).bdNoExtras)}</div>
      `;

      successOverlay.style.display = 'flex';
      btnBackToCalendar.focus();

      const esc = (e)=>{ if(e.key === 'Escape') hideSuccessOverlay(); };
      document.addEventListener('keydown', esc, { once:true });

      btnBackToCalendar.onclick = hideSuccessOverlay;
      btnNewRequest.onclick = ()=>{
        hideSuccessOverlay();
        const start = new Date(); start.setDate(start.getDate()+7); start.setHours(10,0,0,0);
        const end = new Date(start.getTime() + DEFAULT_TAP_MINUTES*60000);
        openModal({ school: SCHOOLS[currentKey]?.name || '', start, end });
      };
    }

    function hideSuccessOverlay(){ successOverlay.style.display = 'none'; }

    function showToast(text){
      successText.textContent = text;
      successMsg.classList.add('show');
      setTimeout(()=> successMsg.classList.remove('show'), 3000);
    }

    /* ===== Submit naar Apps Script ===== */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZQjkpuT-W74YbqFf31nEPmxYQd_5diE7yhfUk3JLegLxqa44L8ngcR_EBib4YSMdS/exec";
    const SECRET = "kidbike_0d2e1f8d3a7c4b9e5f2a1c8d7b4e3f";

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      wasSubmitted = true;
      if(!validateTimes()) {
        const firstErr = [fPersons,fFrom,fTo,fEmail,fPhoneNat,fStreet,fHouse,fZip,fCity]
          .find(el=>el.classList.contains('error'));
        if(firstErr) firstErr.focus();
        return;
      }

      btnSubmit.classList.add('loading');
      btnSubmit.disabled = true;
      btnSubmit.textContent = (langSelect.value==='en'?'Sending…':'Senden…');

      try{
        const nameCombined = [fSalutation.value, fFirstName.value, fLastName.value].filter(Boolean).join(' ').trim();
        const phoneCombined = [fPhoneCountry.value, (fPhoneNat.value||'').trim()].filter(Boolean).join(' ');

        // Build extras dynamically from the rendered checkboxes
        const extrasChecked = Array.from(document.querySelectorAll('#extrasContainer input:checked'));
        const extrasList = extrasChecked.map(el =>
          (langSelect.value === 'en' ? el.dataset.labelEn : el.dataset.labelDe) || el.id.replace(/^x_/, '')
        );

        const payload = {
          secret: SECRET,
          school:  fSchool.value,
          from:    fFrom.value,
          to:      fTo.value,
          persons: fPersons.value,
          type_free: fTypeFree.value,
          bikes:   fBikes.value,
          salutation: fSalutation.value,
          first_name: fFirstName.value,
          last_name:  fLastName.value,
          name:    nameCombined || (fFirstName.value + ' ' + fLastName.value).trim(),
          email:   fEmail.value,
          phone_country: fPhoneCountry.value,
          phone_national: fPhoneNat.value,
          phone:   phoneCombined,
          street:  fStreet.value,
          house:   fHouse.value,
          zip:     fZip.value,
          city:    fCity.value,
          zipcity: fZipCity.value,
          address: formatAddress(),
          message: fMsg.value,
          extras: extrasList,
          lang: langSelect.value || 'de',
          price: CURRENT_PRICE,
          priceText: priceValue.textContent,
          accepted_terms: !!fAccept.checked
        };

        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload),
          redirect: 'follow'
        });

        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error('Serverfehler: ' + txt);
        }
        const out = await res.json().catch(()=>({ok:true}));
        if (!out.ok) throw new Error(out.error || 'Unbekannter Fehler');

        showSuccessOverlay({
          school: payload.school,
          from:   payload.from,
          to:     payload.to,
          persons: payload.persons
        });
        closeModal();
      }catch(err){
        alert('Senden fehlgeschlagen: ' + (err.message || err));
      }finally{
        btnSubmit.classList.remove('loading');
        btnSubmit.disabled = false;
        btnSubmit.textContent = (I18N[langSelect.value]||I18N.de).btnSend || 'Anfrage senden';
      }
    });

    /* ===== embed-size throttle ===== */
    function _sendHeight(){
      var doc=document.documentElement, body=document.body;
      var h=Math.max(body.scrollHeight, body.offsetHeight, doc.clientHeight, doc.scrollHeight, doc.offsetHeight);
      parent.postMessage({ type:'embed-size', height:h }, '*');
    }
    const sendHeightThrottled = debounce(_sendHeight, 120);
    window.addEventListener('load', sendHeightThrottled);
    window.addEventListener('resize', sendHeightThrottled);
    var ro = new ResizeObserver(()=>sendHeightThrottled());
    ro.observe(document.body);

    /* ===== Init ===== */
    (async function init(){
      logoImg.style.display = 'block';
      document.getElementById('calendarLoading').firstChild.nodeValue = (I18N[langSelect.value]||I18N.de).loadingCalendar;
      await discoverSchools();
      applyI18n();
      window.addEventListener('resize', () => applyResponsiveView());
      document.body.classList.toggle('touch', isTouchDevice());
    })();

  </script>
</body>
</html>